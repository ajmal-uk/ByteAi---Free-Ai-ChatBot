<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Image Describer (Offline)</title>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    .output {
      font-size: 18px;
      font-weight: bold;
      margin-top: 15px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2>Upload Image to Get Smart Description</h2>
  <input type="file" id="imageUpload" accept="image/*"><br><br>
  <canvas id="canvas"></canvas>
  <div class="output" id="description">No description yet.</div>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5"></script>
  <script>

    const imageUpload = document.getElementById('imageUpload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const descriptionDiv = document.getElementById('description');

    let modelPromise = cocoSsd.load();

    imageUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = async () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const model = await modelPromise;
        descriptionDiv.textContent = "Analyzing image...";

        // === Detect objects ===
        const predictions = await model.detect(img);
        const objects = predictions.map(p => p.class);
        const uniqueObjects = [...new Set(objects)];

        // Draw boxes
        predictions.forEach(pred => {
          const [x, y, width, height] = pred.bbox;
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, width, height);
          ctx.font = "16px Arial";
          ctx.fillStyle = "red";
          ctx.fillText(pred.class, x, y > 20 ? y - 5 : y + 15);
        });

        // === OCR with Tesseract ===
        const textResult = await Tesseract.recognize(img, 'eng', {
          logger: m => console.log(m)
        });

        let rawText = textResult.data.text.trim();
        let confidence = textResult.data.confidence || 0;

        // Clean and filter garbage
        let cleanedText = rawText.replace(/[^a-zA-Z0-9\s]/g, '').trim();
        const hasValidText = cleanedText.length > 5 && confidence > 60;

        // === Final description ===
        let description = "";

        const hasObjects = uniqueObjects.length > 0;

        if (hasObjects && hasValidText) {
          description += "Detected objects: " + uniqueObjects.join(', ') + ".\n";
          description += "Text in image: \"" + cleanedText + "\"";
        } else if (hasObjects && !hasValidText) {
          description += "A photo containing: " + uniqueObjects.join(', ') + ".";
        } else if (!hasObjects && hasValidText) {
          description += "This image appears to only contain text:\n\n" + cleanedText;
        } else {
          description += "Nothing meaningful detected in the image.";
        }

        descriptionDiv.textContent = description;
      };

      img.src = URL.createObjectURL(file);
    });
  </script>
</body>
</html>
