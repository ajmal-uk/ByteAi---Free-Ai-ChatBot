<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="lang" content="en">
    <title>Byte Ai Chat – Free AI Chatbot for Coding & Writing</title>
    <meta name="description" content="Chat with Byte Ai, a free, privacy-first AI chatbot for coding, writing, and productivity. No sign-up required. Powered by advanced AI models. Enhanced features for better user experience.">
    <meta name="keywords" content="Free AI chatbot, ChatGPT alternative, AI writing assistant, AI coding helper, privacy-focused AI, Byte Ai chat, productivity AI, no login AI chat, online AI assistant, conversational AI, AI image generation, code preview, system theme support">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Time Load">
    <link rel="canonical" href="https://byteai.pythonanywhere.com/chat">
    <link rel="sitemap" href="https://byteai.pythonanywhere.com/sitemap.xml" type="application/xml">
    <meta property="og:title" content="Byte Ai Chat – Free AI Chatbot for Coding & Writing">
    <meta property="og:description" content="Chat with Byte Ai, a free, privacy-first AI chatbot for coding, writing, and productivity. No sign-up needed. Powered by advanced AI models. Now with improved SEO, system theme, and enhanced features.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://byteai.pythonanywhere.com/chat">
    <meta property="og:image" content="https://byteai.pythonanywhere.com/static/images/byteai-chat-social.jpg">
    <meta property="og:site_name" content="Byte Ai">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Byte Ai Chat – Free AI Chatbot for Coding & Writing">
    <meta name="twitter:description" content="Chat with Byte Ai, a free, privacy-first AI chatbot for coding, writing, and productivity. No sign-up needed. Powered by advanced AI models. Improved performance and features.">
    <meta name="twitter:image" content="https://byteai.pythonanywhere.com/static/images/byteai-chat-twitter.jpg">
    <meta name="twitter:site" content="@TimeLoad7">
    <link rel="icon" href="https://byteai.pythonanywhere.com/static/images/Favicon/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/svg+xml" href="https://byteai.pythonanywhere.com/static/images/Favicon/favicon.svg">
    <link rel="apple-touch-icon" href="https://byteai.pythonanywhere.com/static/images/Favicon/apple-touch-icon.png">
    <link rel="manifest" href="https://byteai.pythonanywhere.com/static/images/Favicon/site.webmanifest">
    <meta name="msapplication-TileImage" content="https://byteai.pythonanywhere.com/static/images/Favicon/favicon-96x96.png">
    <meta name="theme-color" content="#6C63FF">
    <link rel="preload" href="https://byteai.pythonanywhere.com/static/images/byteai-chat.jpg" as="image">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai-sublime.min.css" as="style">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai-sublime.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "Byte Ai Chat",
        "headline": "Byte Ai Chat – Free AI Chatbot for Productivity, Coding, and Writing",
        "description": "Engage with Byte Ai's free, privacy-first chatbot for coding, writing, and productivity tasks. Powered by Time Load's multi-model AI, it's a top ChatGPT alternative. Enhanced with system theme support, improved code preview, and better SEO.",
        "url": "https://byteai.pythonanywhere.com/chat",
        "image": "https://byteai.pythonanywhere.com/static/images/byteai-chat-social.jpg",
        "datePublished": "2025-05-12",
        "dateModified": "2025-08-12",
        "keywords": [
            "Byte Ai chat",
            "free AI chatbot",
            "ChatGPT alternative",
            "AI coding assistant",
            "AI writing assistant",
            "privacy-focused AI",
            "no sign-up AI chat",
            "multi-model AI chatbot",
            "AI productivity tool",
            "secure AI chatbot",
            "conversational AI",
            "AI for developers",
            "AI for writers",
            "AI image generation",
            "code preview tool",
            "system theme AI chat"
        ],
        "publisher": {
            "@type": "Organization",
            "name": "Time Load",
            "url": "https://byteai.pythonanywhere.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https://byteai.pythonanywhere.com/static/images/logo.jpg"
            },
            "founder": {
                "@type": "Person",
                "name": "Muhammed Ajmal U K",
                "url": "https://byteai.pythonanywhere.com/about"
            },
            "contactPoint": {
                "@type": "ContactPoint",
                "contactType": "Customer Support",
                "email": "contact.byteai@gmail.com",
                "url": "https://byteai.pythonanywhere.com/contact"
            },
            "sameAs": [
                "https://x.com/TimeLoad7"
            ]
        },
        "isPartOf": {
            "@type": "WebSite",
            "name": "Byte Ai",
            "url": "https://byteai.pythonanywhere.com",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://byteai.pythonanywhere.com/search?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        },
        "about": {
            "@type": "Service",
            "name": "Byte Ai Chat Service",
            "url": "https://byteai.pythonanywhere.com/chat",
            "description": "Byte Ai is a free, privacy-first ChatGPT alternative for writing, coding, and productivity. No login required. Now with system theme, enhanced code features, and improved SEO.",
            "provider": {
                "@type": "Organization",
                "name": "Time Load",
                "url": "https://byteai.pythonanywhere.com"
            },
            "serviceType": "AI Chatbot Service",
            "areaServed": "Global",
            "offers": {
                "@type": "Offer",
                "price": "0",
                "priceCurrency": "USD",
                "availability": "InStock"
            }
        },
        "hasPart": {
            "@type": "WebApplication",
            "name": "Byte Ai Chat",
            "url": "https://byteai.pythonanywhere.com/chat",
            "applicationCategory": "Productivity",
            "operatingSystem": "All",
            "description": "Byte Ai Chat is a free, privacy-focused AI chatbot for productivity, writing, and coding tasks, offering a seamless and secure user experience with advanced features like code preview and system theme support.",
            "featureList": [
                "AI-powered chat",
                "Code generation",
                "Content writing",
                "Privacy-first design",
                "Customizable themes",
                "Chat history management",
                "Image generation",
                "Code preview",
                "System theme integration"
            ],
            "offers": {
                "@type": "Offer",
                "price": "0",
                "priceCurrency": "USD"
            },
            "aggregateRating": {
                "@type": "AggregateRating",
                "ratingValue": "4.9",
                "reviewCount": "130"
            },
            "publisher": {
                "@type": "Organization",
                "name": "Time Load"
            }
        },
        "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Home",
                    "item": "https://byteai.pythonanywhere.com/"
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "Chat",
                    "item": "https://byteai.pythonanywhere.com/chat"
                }
            ]
        },
        "mainEntity": {
            "@type": "FAQPage",
            "mainEntity": [
                {
                    "@type": "Question",
                    "name": "How do I use Byte Ai Chat?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Visit the Byte Ai chat page, enter your query in the chat input, and start interacting with our AI instantly – no sign-up required."
                    }
                },
                {
                    "@type": "Question",
                    "name": "What features does Byte Ai Chat offer?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Byte Ai Chat supports coding assistance, content creation, productivity tasks, customizable themes, chat history management, image generation, code preview, and system theme support with a privacy-first approach."
                    }
                },
                {
                    "@type": "Question",
                    "name": "Is Byte Ai Chat free?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Yes, Byte Ai Chat is completely free to use for all its features, including coding, writing assistance, and image generation."
                    }
                },
                {
                    "@type": "Question",
                    "name": "How does Byte Ai Chat ensure privacy?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Byte Ai Chat uses end-to-end encryption, processes requests anonymously, and does not store user data."
                    }
                },
                {
                    "@type": "Question",
                    "name": "Can I generate images with Byte Ai?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Yes, Byte Ai Chat includes an image generation feature. Simply enable the 'Image' option when sending your prompt to create images based on your description."
                    }
                },
                {
                    "@type": "Question",
                    "name": "Does Byte Ai support code preview?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Yes, for HTML code blocks, you can preview the code directly in an overlay with browser-like rendering."
                    }
                }
            ]
        }
    }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap');
        * {
            margin: 0;
            padding: 0;
            outline: none;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--primary-color);
            overflow: hidden;
        }
        body:not(.hide-header) .chats {
            display: none;
        }
        body.light_mode {
            --primary-color: #f9f9f9;
            --secondary-color: #e8e8e8;
            --secondary-hover-color: #d0d0d0;
            --focus-color: #e8e8e8;
            --focus-hover-color: #e8e8e8;
            --button-hover-color: #e9ecf1;
            --code-block-lebal-color: #c4c4c4;
            --code-block-bg-color: #000;
            --code-block-border-color: #c4c4c4;
            --text-color: #000;
            --text-secondary-color: #4d4d4d;
            --heading-secondary-color: #c4c7c5;
            --placeholder-color: #717075;
            --sent-icon-color: #fff;
            --error-color: #e55865;
            --accent-color: #4a90e2;
            --input-border-color: #cccccc;
            --sent-border-color: #444444;
            --scrollbar-thumb-color: #999;
            --accent-hover: #6aa8f0;
            --hljs-background: #f9f9f9;
            --hljs-color: #000;
            --hljs-keyword: #d63200;
            --hljs-string: #008000;
            --hljs-comment: #808080;
            --hljs-title: #2e8b57;
        }
        body.dark_mode {
            --primary-color: #1e1e1e;
            --secondary-color: #2a2a2e;
            --secondary-hover-color: #39393f;
            --focus-color: #2a2a2e;
            --focus-hover-color: #2a2a2e;
            --button-hover-color: #3a3f4b;
            --code-block-lebal-color: #343746;
            --code-block-bg-color: #1a1b26;
            --code-block-border-color: #44475a;
            --text-color: #f5f5f5;
            --text-secondary-color: #cfcfcf;
            --heading-secondary-color: #8a8fa3;
            --placeholder-color: #979ca8;
            --sent-icon-color: #000;
            --error-color: #ff6b6b;
            --success-color: #4cd964;
            --info-color: #5ac8fa;
            --accent-color: #7aa2f7;
            --accent-hover: #9db9ff;
            --input-border-color: #44475a;
            --sent-border-color: #3a3a3a;
            --scrollbar-thumb-color: #555;
            --hljs-background: #282a36;
            --hljs-color: #f8f8f2;
            --hljs-keyword: #ff79c6;
            --hljs-string: #f1fa8c;
            --hljs-comment: #6272a4;
            --hljs-title: #50fa7b;
        }
        body.byte_mode {
            --primary-color: #0A0A12;
            --secondary-color: #13131f;
            --secondary-hover-color: #1d1d2b;
            --focus-color: #13131f;
            --focus-hover-color: #13131f;
            --button-hover-color: #2a2a40;
            --code-block-lebal-color: #2e2e44;
            --code-block-bg-color: #14141f;
            --code-block-border-color: #3b3b5a;
            --text-color: #f0f0f5;
            --text-secondary-color: #c4c4d1;
            --heading-secondary-color: #8f96b2;
            --placeholder-color: #80869a;
            --sent-icon-color: #000;
            --error-color: #ff5c5c;
            --success-color: #33d17a;
            --info-color: #4bb3fd;
            --accent-color: #7a8cff;
            --accent-hover: #a0aefe;
            --input-border-color: #393953;
            --sent-border-color: #202030;
            --scrollbar-thumb-color: #44445e;
            --hljs-background: #1c1c2b;
            --hljs-color: #f8f8f2;
            --hljs-keyword: #ff79c6;
            --hljs-string: #f1fa8c;
            --hljs-comment: #6272a4;
            --hljs-title: #50fa7b;
        }
        body.aurora_night_mode {
            --primary-color: #1b1d29;
            --secondary-color: #25283a;
            --secondary-hover-color: #30354a;
            --focus-color: #25283a;
            --focus-hover-color: #25283a;
            --button-hover-color: #4c5c77;
            --code-block-lebal-color: #3d4153;
            --code-block-bg-color: #1a1d2e;
            --code-block-border-color: #444a6d;
            --text-color: #f0f0f5;
            --text-secondary-color: #c0c3cc;
            --heading-secondary-color: #8895b0;
            --placeholder-color: #9aa0b3;
            --sent-icon-color: #000;
            --error-color: #ff5c75;
            --success-color: #32d27e;
            --info-color: #57c4ff;
            --accent-color: #8e9fff;
            --accent-hover: #aebdff;
            --input-border-color: #4d5473;
            --sent-border-color: #2e2f3c;
            --scrollbar-thumb-color: #5e6178;
            --hljs-background: #282c3d;
            --hljs-color: #f5f5f5;
            --hljs-keyword: #f093ff;
            --hljs-string: #e6ff92;
            --hljs-comment: #6c7896;
            --hljs-title: #7afba3;
        }
        body.midnight_tech_mode {
            --primary-color: #121212;
            --secondary-color: #1c1f26;
            --secondary-hover-color: #2b2f39;
            --focus-color: #1c1f26;
            --focus-hover-color: #1c1f26;
            --button-hover-color: #344256;
            --code-block-lebal-color: #2f3747;
            --code-block-bg-color: #10121a;
            --code-block-border-color: #3b4659;
            --text-color: #e5e5e5;
            --text-secondary-color: #b0b0b0;
            --heading-secondary-color: #6a89af;
            --placeholder-color: #7f8c99;
            --sent-icon-color: #000;
            --error-color: #e94f4f;
            --success-color: #28cc7b;
            --info-color: #4bb4f3;
            --accent-color: #5a9cff;
            --accent-hover: #7fb6ff;
            --input-border-color: #404c63;
            --sent-border-color: #292c35;
            --scrollbar-thumb-color: #666d7a;
            --hljs-background: #1a1c24;
            --hljs-color: #f0f0f0;
            --hljs-keyword: #d87fff;
            --hljs-string: #baff73;
            --hljs-comment: #5c6789;
            --hljs-title: #6df0a8;
        }
        body.warm_dusk_mode {
            --primary-color: #1a1917;
            --secondary-color: #2c2b28;
            --secondary-hover-color: #3d3b36;
            --focus-color: #2c2b28;
            --focus-hover-color: #2c2b28;
            --button-hover-color: #544d45;
            --code-block-lebal-color: #3a3732;
            --code-block-bg-color: #211f1c;
            --code-block-border-color: #5a4f47;
            --text-color: #f0eae2;
            --text-secondary-color: #ccc3b8;
            --heading-secondary-color: #bfa98a;
            --placeholder-color: #a69c91;
            --sent-icon-color: #000;
            --error-color: #ff5f5f;
            --success-color: #4db96b;
            --info-color: #6dc7d9;
            --accent-color: #f4a261;
            --accent-hover: #f6b98e;
            --input-border-color: #6c6053;
            --sent-border-color: #332f2a;
            --scrollbar-thumb-color: #6b6257;
            --hljs-background: #292724;
            --hljs-color: #f7f3ec;
            --hljs-keyword: #ffa07a;
            --hljs-string: #d4f88e;
            --hljs-comment: #9c9284;
            --hljs-title: #ffd280;
        }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            border: 0;
            clip: rect(0, 0, 0, 0);
            clip-path: inset(50%);
            overflow: hidden;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            font-size: 3rem;
            color: var(--text-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 2rem;
            text-align: center;
        }
        .welcome-screen.hidden {
            display: none;
        }
        .welcome-title {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: var(--text-color);
            font-weight: 600;
        }
        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary-color);
            margin-bottom: 1rem;
            max-width: 600px;
        }
        .welcome-input {
            width: 100%;
            max-width: 400px;
            height: 50px;
            padding: 0 1rem;
            border: 1px solid var(--input-border-color);
            border-radius: 30px;
            font-size: 1.1rem;
            background: var(--secondary-color);
            color: var(--text-color);
            margin-bottom: 2rem;
            text-align: center;
            outline: none;
            transition: background 0.3s ease;
        }
        .welcome-input.error {
            border-color: red;
        }
        .welcome-input:focus {
            background: var(--focus-color);
        }
        .welcome-input::placeholder {
            color: var(--placeholder-color);
        }
        .welcome-button {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .welcome-button:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }
        .welcome-button:active {
            transform: translateY(0);
        }
        .navbar {
            position: sticky;
            top: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            z-index: 1000;
        }
        .navbar__right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .navbar__new-chat {
            background: transparent;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
            padding: 0.25rem;
            border-radius: 50%;
            margin-right: 15px;
        }
        .navbar__new-chat i {
            color: var(--text-secondary-color);
            font-size: 1.7rem;
        }
        .navbar__new-chat:hover {
            background: var(--secondary-hover-color);
        }
        .navbar__user {
            display: flex;
            align-items: center;
        }
        .navbar__user-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--accent-color);
        }
        .header__title h1 {
            width: fit-content;
            background: linear-gradient(to right, #4a90e2, #a355b9, #ff6b6b);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 3.25rem;
            font-weight: 600;
        }
        .header__title h2 {
            color: var(--heading-secondary-color);
            font-size: 3.25rem;
            font-weight: 600;
        }
        .chats .message,
        .chats .message .message__content,
        .prompt__form {
            margin: 0 auto;
            max-width: 824px;
        }
        .chats {
            cursor: default;
            max-height: calc(100vh - 10rem);
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 120px;
        }
        .chats::-webkit-scrollbar {
            width: 8px;
            border-radius: 100px;
        }
        .chats::-webkit-scrollbar-thumb {
            background-color: #666;
            border-radius: 100px;
        }
        .chats::-webkit-scrollbar-track {
            background-color: var(--focus-color);
            border-radius: 100px;
        }
        .chats .message--incoming {
            margin-top: 0.5rem;
        }
        .chats .message--outgoing:not(:first-child) {
            margin-top: 1rem;
        }
        .chats .message__content {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            width: 100%;
        }
        .message__text .image-container {
            margin: 0;
            width: 100%;
            display: block;
            text-align: left;
        }
        .chats .message--image-loading .message__text {
            display: block;
        }
        .chats .message--outgoing .message__content {
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
            max-width: 100%;
            margin-left: auto;
        }
        .chats .message__text {
            color: var(--text-color);
            white-space: pre-wrap;
            margin-top: 5px;
        }
        .chats .message--outgoing .message__text {
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding: 0.5rem 1rem;
            border-radius: 1rem 1rem 0 1rem;
            max-width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chats .message--error .message__text {
            color: var(--error-color);
        }
        .chats .message--loading .message__text {
            display: none;
        }
        .chats .message__icon {
            color: var(--text-color);
            cursor: pointer;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            font-size: 1rem;
            margin-left: 0.1rem;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .message__icons {
            display: flex;
            justify-content: flex-start;
            gap: 0.5rem;
            margin-top: 0.05rem;
        }
        .message__icon i {
            color: inherit;
        }
        .message__icon.selected {
            color: var(--accent-color);
        }
        .hide {
            display: none;
        }
        .chats .message__icon:hover {
            background: var(--secondary-hover-color);
            transform: scale(1.1);
        }
        .chats .message__loading-indicator {
            display: none;
            gap: 0.6rem;
            width: 100%;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .chats .message--loading .message__loading-indicator {
            display: flex;
        }
        .chats .message__loading-indicator .message__loading-bar {
            height: 1rem;
            width: 100%;
            border-radius: 0.135rem;
            background-position: -800px 0;
            background: linear-gradient(to right, var(--scrollbar-thumb-color) 30%, var(--primary-color) 60%, var(--heading-secondary-color));
            animation: loading 3s linear infinite;
        }
        .chats .message__loading-indicator .message__loading-bar:first-child {
            width: 85%;
        }
        .chats .message__loading-indicator .message__loading-bar:last-child {
            width: 70%;
        }
        .chats .message--incoming .message__content {
            flex-direction: column;
            padding-left: 0;
            margin-left: 0;
        }
        .message--incoming:not(.message--thinking) .message__content {
            padding-left: 0;
            border-left: none;
        }
        .message--final-response .message__content {
            padding-left: 0 !important;
            border-left: none !important;
        }
        .greeting-container {
            text-align: center;
            color: var(--text-color);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
        }
        .greeting-container h1 {
                    font-size: 2rem;
                    font-weight: 600;
        }
        .greeting-container h2 {
                    font-size: 1.2rem;
                    color: var(--text-secondary-color);
        }
        body.hide-header .greeting-container {
            display: none;
        }
        .prompt {
            background: var(--primary-color);
            z-index: 1000;
            width: 100%;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        .prompt__input-wrapper {
            border: 1px solid var(--input-border-color);
            border-radius: 30px;
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .prompt__form-input {
            cursor: text;
            height: 74px;
            max-height: 225px;
            min-height: 74px;
            width: 100%;
            overflow-y: auto;
            border: none;
            resize: none;
            font-size: 1.1rem;
            color: var(--text-color);
            padding: 0.75rem 1rem;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            background: var(--secondary-color);
            transition: background 0.3s ease;
            line-height: 1.5rem;
        }
        .prompt__form-input::-webkit-scrollbar {
            width: 8px;
            border-radius: 100px;
        }
        .prompt__form-input::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb-color);
            border-radius: 100px;
            cursor: default;
        }
        .prompt__form-input::-webkit-scrollbar-track {
            background-color: transparent;
            border-radius: 100px;
        }
        .prompt__form-input:focus {
            background: var(--focus-color);
            outline: none;
        }
        .prompt__form-input:focus~.prompt__form-button:hover {
            background: var(--focus-hover-color);
        }
        .prompt__form-input::placeholder {
            color: var(--placeholder-color);
            transition: opacity 0.3s ease;
        }
        .prompt__form-input:valid~#sendButton {
            opacity: 1;
            pointer-events: auto;
        }
        .prompt__form-input:valid~.prompt__bottom-row .prompt__form-button#sendButton {
            opacity: 1;
            pointer-events: auto;
        }
        .prompt__bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--secondary-color);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            padding: 0.5rem 1rem;
        }
        .prompt__buttons-left {
            display: flex;
            gap: 0.7rem;
            align-items: center;
        }
        .prompt__options-row {
            display: flex;
            gap: 0.7rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .prompt__option {
            display: flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.6rem 0.8rem;
            border-radius: 25px;
            border: 1px solid var(--input-border-color);
            background-color: var(--primary-color);
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .prompt__option.selected {
            background-color: var(--accent-color);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .prompt__option:hover {
            background-color: var(--secondary-hover-color);
            transform: scale(1.05);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .prompt__option.selected:hover {
            background-color: var(--accent-hover);
            transform: scale(1.1);
        }
        .prompt__option i {
            font-size: 1rem;
        }
        .prompt__option span {
            font-size: 0.9rem;
        }
        @media (max-width: 768px) {
            .prompt__option span {
                display: none;
            }
            .prompt__option.selected span {
                display: inline;
                margin-left: 0.3rem;
            }
        }
        .prompt__form-button {
            position: static;
            transform: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            background: var(--text-color);
            color: var(--sent-icon-color);
            border: 1px solid var(--sent-border-color);
            opacity: 0.5;
            pointer-events: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .prompt__form-button:hover {
            background: var(--text-secondary-color);
            transform: scale(1.1);
        }
        .save-button {
            display: block;
            margin: 0 auto;
            padding: 0.6rem 1.5rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: 1px solid var(--text-color);
        }
        .save-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        .delete-button {
            background-color: red;
            color: #fff;
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .delete-button:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        #saveButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sidebar {
            position: fixed;
            bottom: 0;
            left: 0;
            height: 100%;
            width: 250px;
            background-color: var(--primary-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1001;
            padding: 1rem;
            border-radius: 8px 0 0 8px;
            border-right: 2px solid var(--secondary-color);
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar__header {
            margin-top: 50px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
            padding-bottom: 1rem;
        }
        .sidebar__body {
            flex-grow: 1;
            margin-top: 1.5rem;
        }
        .sidebar__body-item {
            padding: 0.75rem;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.3s ease, transform 0.2s ease;
            color: var(--text-secondary-color);
            margin-bottom: 1rem;
        }
        .sidebar__body-item:hover {
            background: var(--secondary-hover-color);
            transform: translateX(5px);
        }
        .sidebar__body-item.selected {
            background-color: var(--secondary-hover-color);
        }
        .sidebar__footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.85rem;
            color: var(--placeholder-color);
            margin-top: 1rem;
            margin-bottom: 20px;
        }
        .new-chat-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--secondary-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-bottom: 0.5rem;
        }
        .new-chat-button i {
            font-size: 1.2rem;
            color: var(--text-secondary-color);
        }
        .new-chat-button span {
            color: var(--text-secondary-color);
        }
        .new-chat-button:hover {
            background: var(--secondary-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .new-chat-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        #chatHistoryList {
            max-height: 300px;
            overflow-y: auto;
        }
        #chatHistoryList::-webkit-scrollbar {
            width: 8px;
            border-radius: 100px;
        }
        #chatHistoryList::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb-color);
            border-radius: 100px;
        }
        #chatHistoryList::-webkit-scrollbar-track {
            background-color: transparent;
            border-radius: 100px;
        }
        .session-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .options-menu {
            display: none;
            position: fixed;
            background: var(--secondary-color);
            border: 1px solid var(--input-border-color);
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1002;
            min-width: 100px;
        }
        .delete-option:hover {
            background: var(--secondary-hover-color);
        }
        .scroll-button {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
            padding: 10px 15px;
            font-size: 20px;
            border: none;
            border-radius: 50%;
            background-color: var(--secondary-hover-color);
            color: #fff;
            cursor: pointer;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0.9;
            margin-bottom: 75px;
        }
        .scroll-button i {
            font-size: 20px;
        }
        #sidebarToggler {
            position: fixed;
            top: 12px;
            left: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 1002;
            transition: opacity 0.3s ease;
            transform-origin: center center;
        }
        .sidebar-toggler-icon {
            font-size: 1.8rem;
            color: var(--text-color);
            display: block;
            margin: auto;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }
        #sidebarToggler.rotate .sidebar-toggler-icon {
            animation: rotateGear 1s ease forwards;
        }
        #sidebarToggler.reverseRotate .sidebar-toggler-icon {
            animation: reverseRotateGear 1s ease forwards;
        }
        #sidebarToggler.hidden .sidebar-toggler-icon {
            opacity: 0;
            pointer-events: none;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: none;
            z-index: 1000;
        }
        .overlay.show {
            display: block;
        }
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        .popup.show {
            display: flex;
        }
        .popup__container {
            background: var(--primary-color);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .popup__close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.2rem;
            color: var(--text-color);
            cursor: pointer;
            z-index: 10000;
            background: var(--secondary-color);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup__left {
            flex: 0 0 180px;
            background-color: var(--secondary-hover-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .popup__button {
            margin: 5px 0;
            padding: 0.4rem;
            background: none;
            border: none;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            width: 100%;
        }
        .popup__button:hover {
            background-color: var(--secondary-color);
            font-size: 0.91rem;
        }
        .popup__button.selected {
            border: 2px solid var(--text-color);
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        .popup__right {
            flex: 1;
            padding: 0.75rem;
            background: var(--secondary-color);
        }
        .popup__content {
            display: none;
        }
        .popup__content.active {
            display: block;
        }
        #themeSelector {
            width: 100%;
            max-width: 300px;
            padding: 0.75rem;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--secondary-color);
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #themeSelector:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: var(--focus-color);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        #themeSelector option {
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 1rem;
            padding: 0.5rem;
        }
        #themeSelector:hover {
            background-color: var(--secondary-hover-color);
            border-color: var(--accent-hover);
        }
        .confirmation_popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 450px;
            background: var(--secondary-hover-color);
            color: #721c24;
            border-radius: 8px;
            overflow: hidden;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 20px;
            height: auto;
            border: 2px solid var(--text-secondary-color);
            text-align: center;
        }
        .confirmation_popup i {
            font-size: 60px;
            color: red;
            margin: 0 auto 20px auto;
            display: block;
        }
        .confirmation_popup .confirmation_message {
            font-size: 22px;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 15px;
            text-align: center;
        }
        .confirmation_popup .confirmation_description {
            font-size: 16px;
            color: #eeff00;
            margin-bottom: 20px;
            text-align: center;
        }
        .confirmation_popup .confirmation_buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .confirmation_popup .cancel_button,
        .confirmation_popup .confirm_button {
            background: #6c757d;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #5a6268;
            padding: 10px 20px;
            cursor: pointer;
            width: 120px;
            display: inline-block;
            transition: background 0.3s ease;
        }
        .confirmation_popup .confirm_button {
            background: #dc3545;
            border: 1px solid #c82333;
        }
        .confirmation_popup .cancel_button:hover {
            background: #5a6268;
        }
        .confirmation_popup .confirm_button:hover {
            background: #c82333;
        }
        .profile-image-container {
            margin-top: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
        }
        .profile-image-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--accent-color);
        }
        #profileImagePreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .editimage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
            color: var(--text-secondary-color);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .profile-image-wrapper:hover .editimage {
            opacity: 1;
        }
        .edit-icon {
            font-size: 1.3rem;
        }
        .label {
            font-weight: bold;
            display: block;
            text-align: center;
            margin-top: 1rem;
        }
        .username-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        .input-field {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--secondary-hover-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .edit-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: none;
        }
        .edit-icon {
            font-size: 1.25rem;
            color: red;
            transition: color 0.3s ease;
        }
        .input-field:disabled~.edit-overlay {
            display: flex;
        }
        .input-field:disabled {
            background-color: var(--secondary-hover-color);
            color: var(--secondary-color);
            cursor: not-allowed;
        }
        .date-field {
            width: 65%;
            padding: 0.5rem;
            margin: 0.5rem auto 1.5rem auto;
            border-radius: 8px;
            display: block;
            background-color: var(--secondary-hover-color);
            font-size: 0.9rem;
            color: var(--text-color);
        }
        .date-field:focus {
            outline: none;
        }
        .date-field::-webkit-calendar-picker-indicator {
            background-color: var(--primary-color);
            border-radius: 50%;
            padding: 0.2rem;
        }
        .date-field::-webkit-calendar-picker-indicator:hover {
            background-color: #0056b3;
        }
        .date-field::-moz-calendar-picker-indicator {
            background-color: #007bff;
            border-radius: 50%;
        }
        .sub-menu-wrap {
            position: absolute;
            top: 100%;
            right: 2%;
            width: 320px;
            max-height: 0px;
            overflow: hidden;
            transition: max-height 0.5s;
        }
        .sub-menu-wrap.open-menu {
            max-height: 400px;
        }
        .sub-menu {
            background-color: var(--secondary-color);
            padding: 20px;
            margin: 10px;
            border-radius: 10px;
            border: 1px solid var(--text-color);
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info h2 {
            font-weight: 500;
            font-size: 1rem;
            color: var(--text-color);
        }
        .user-info img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin: 15px;
            border: 2px solid var(--text-color);
        }
        .sub-menu hr {
            border: 0;
            height: 2px;
            width: 100%;
            background: var(--text-secondary-color);
            margin: 15px 0 10px;
        }
        .sub-menu-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary-color);
            margin: 12px 0;
        }
        .sub-menu-link i {
            font-size: 16px;
            margin-right: 10px;
            line-height: 0;
        }
        .sub-menu-link p {
            margin: 0;
            flex-grow: 1;
            font-size: 16px;
            width: 100px;
        }
        .sub-menu-link span {
            margin-left: auto;
            font-size: 16px;
            transition: transform 0.5s;
        }
        .sub-menu-link:hover span {
            transform: translateX(5px);
            font-size: 17px;
        }
        .sub-menu-link:hover p {
            font-size: 17px;
        }
        .sub-menu-link:hover i {
            font-size: 17px;
        }
        .edit-message-input {
            background: var(--secondary-color);
            color: var(--text-color);
            border-radius: 15px;
            padding: 0.75rem 1rem;
            width: 100%;
            min-height: 80px;
            resize: vertical;
            border: none;
            outline: none;
            padding-bottom: 2.5rem;
            font-size: 1rem;
        }
        .edit-message-input::-webkit-scrollbar {
            width: 8px;
            border-radius: 100px;
        }
        .edit-message-input::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb-color);
            border-radius: 100px;
        }
        .edit-message-input::-webkit-scrollbar-track {
            background-color: transparent;
            border-radius: 100px;
        }
        .edit-message-cancel,
        .edit-message-submit {
            background: var(--secondary-hover-color);
            color: var(--text-color);
            border-radius: 20px;
            padding: 0.4rem 1rem;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.9rem;
        }
        .edit-message-submit {
            background: var(--text-color);
            color: var(--sent-icon-color);
        }
        .edit-message-cancel:hover,
        .edit-message-submit:hover {
            background: var(--secondary-hover-color);
        }
        p {
            margin-bottom: 10px;
        }
        ul {
            list-style: disc inside;
            margin-left: 20px;
        }
        ol {
            margin-left: 40px;
        }
        strong {
            font-weight: bold;
        }
        em {
            font-style: italic;
        }
        a {
            color: #1e90ff;
            text-decoration: none;
        }
        table {
            width: 100%;
            table-layout: fixed;
            overflow-wrap: break-word;
            border-collapse: collapse;
        }
        th,
        td {
            border: 1px solid;
            text-align: left;
            padding: 10px;
            word-wrap: break-word;
        }
        th {
            font-weight: bold;
            background-color: var(--focus-color);
        }
        tr:nth-child(even) {
            background-color: var(--focus-color);
        }
        blockquote {
            padding-left: 60px;
            line-height: 2.5rem;
            color: var(--text-color);
        }
pre {
    position: relative;
    background-color: var(--code-block-lebal-color);
    font-family: 'Fira Code', monospace;
    font-size: 14px;
    margin: 0;
    overflow-x: auto;
    white-space: pre-wrap;
    max-width: 100%; /* Ensures it doesn’t exceed parent */
    box-sizing: border-box;
    border: 1px solid var(--code-block-border-color);
    width: 100%; /* Full width of parent */
    word-wrap: break-word;
    border-radius: 0 0 8px 8px;
    border-top: none;
    line-height: 1.5; /* Added for better readability */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
        code {
            border-bottom-right-radius: 10px;
            border-bottom-left-radius: 10px;
            border: 1px solid var(--code-block-border-color);
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .code__language-label {
            position: absolute;
            font-weight: bold;
            top: 10px;
            left: 12px;
            color: var(--placeholder-color);
            font-size: 14px;
            text-transform: capitalize;
        }
        .code__copy-btn {
            background-color: transparent;
            border: none;
            color: var(--text-color);
            border-radius: 5px;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 12px;
            z-index: 10;
            font-size: 18px;
            transition: color 0.3s ease;
        }
        .code__copy-btn:hover {
            color: var(--accent-color);
        }
        .generated-image {
            max-width: 100%;
            height: auto;
            max-height: 250px;
            border-radius: 8px;
            margin: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            display: block;
            cursor: pointer;
        }
        .generated-image:hover {
            transform: scale(1.02);
        }
        .image-container {
            position: relative;
            display: block;
            width: 100%;
            text-align: left;
        }
        .chats .message--image .message__content {
            display: block;
            gap: 0;
        }
        .chats .message--image .message__text > * {
            margin: 0;
        }
        .chats .message--image .message__content {
            margin: 0;
        }
        .chats .message--image .message__icons {
            margin: 0;
        }
        .chats .message--image .message__text {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        .chats .message--image .image-container {
            margin: 0;
            padding: 0;
            width: 100%;
            text-align: left;
        }
        .chats .message--image .generated-image {
            margin-left: 0;
            padding: 0;
            display: block;
        }
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        .image-overlay.show {
            display: flex;
        }
        .image-overlay-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .image-overlay img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        .image-overlay-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10001;
        }
        .image-overlay-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            backdrop-filter: blur(10px);
        }
        .image-overlay-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        .image-overlay-btn i {
            font-size: 20px;
        }
        .image-overlay-close {
            background: rgba(255, 59, 48, 0.8);
        }
        .image-overlay-close:hover {
            background: rgba(255, 59, 48, 1);
        }
        .image-loading-message {
            text-align: left;
            color: var(--accent-color);
            font-style: bold;
            font-size: 0.9rem;
            padding: 2px;
            border-radius: 4px;
            position: relative;
            background: linear-gradient(90deg, var(--accent-color), var(--text-secondary-color), var(--accent-color));
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: waveText 2s linear infinite;
        }
        .image-success-message {
            text-align: left;
            font-style: bold;
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, var(--success-color), var(--text-secondary-color), var(--success-color));
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: waveText 2s linear infinite;
        }
        @keyframes waveText {
            0% {
                background-position: 0% 0;
            }
            100% {
                background-position: 100% 0;
            }
        }
        .edit-tag {
            background-color: var(--accent-color);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            width: fit-content;
        }
        .edit-prompt {
            font-weight: bold;
            margin-right: 0.5rem;
        }
        .edit-close {
            cursor: pointer;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .message--image-loading {
            display: block;
            text-align: left;
            padding: 5px 0;
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .image-loading-container {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.8;
            background: linear-gradient(
                135deg,
                var(--heading-secondary-color),
                var(--text-secondary-color),
                var(--heading-secondary-color)
            );
            background-size: 300% 300%;
            animation: waveDiagonal 2.5s linear infinite;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        @keyframes waveDiagonal {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 100% 100%;
            }
        }
        .image-loading-box {
            width: 50px;
            height: 50px;
            border: 3px solid var(--text-secondary-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .reasoning-container {
            margin-top: 15px;
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .reasoning-container.active {
            display: block;
        }
        .reasoning-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        .reasoning-content {
            color: var(--text-secondary-color);
            font-style: italic;
        }
        .reasoning-content {
        transition: opacity 0.3s ease;
    }
    /* Pulsing animation for the reasoning container */
    .reasoning-container {
        animation: Tpulse 2s infinite;
    }
    @keyframes Tpulse {
        0% {
            box-shadow: 0 0 0 0 rgba(122, 140, 255, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(122, 140, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(122, 140, 255, 0);
        }
    }
        .reasoning-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .reasoning-loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--accent-color);
            animation: reasoningPulse 1.4s infinite ease-in-out both;
        }
        .reasoning-loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        .reasoning-loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes reasoningPulse {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .hljs {
            background-color: var(--hljs-background);
            color: var(--hljs-color);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
        }
        .hljs-keyword {
            color: var(--hljs-keyword);
        }
        .hljs-string {
            color: var(--hljs-string);
        }
        .hljs-comment {
            color: var(--hljs-comment);
        }
        .hljs-title {
            color: var(--hljs-title);
        }
        .hljs-params {
            color: var(--hljs-color);
        }
        .hljs-number {
            color: var(--hljs-string);
        }
        .hljs-built_in {
            color: var(--hljs-title);
        }
        .hljs-literal {
            color: var(--hljs-string);
        }
        .hljs-function {
            color: var(--hljs-title);
        }
        .hljs-class {
            color: var(--hljs-title);
        }
        .hljs-tag {
            color: #ff79c6;
        }
        .hljs-attr {
            color: #50fa7b;
        }
        .hljs-attribute {
            color: #ffb86c;
        }
        .hljs-variable {
            color: #bd93f9;
        }
        .hljs-selector-tag {
            color: #ff79c6;
        }
        .hljs-selector-class {
            color: #50fa7b;
        }
        .hljs-selector-id {
            color: #8be9fd;
        }
        .hljs-selector-attr {
            color: #ffb86c;
        }
        .hljs-selector-pseudo {
            color: #ff79c6;
        }
        .hljs-meta {
            color: #6272a4;
        }
        .hljs-link {
            color: #8be9fd;
        }
        .hljs-doctag {
            color: #ff79c6;
        }
        .hljs-type {
            color: #8be9fd;
        }
        .hljs-symbol {
            color: #ff79c6;
        }
        .hljs-bullet {
            color: #50fa7b;
        }
        .hljs-addition {
            color: #50fa7b;
        }
        .hljs-deletion {
            color: #ff5555;
        }
        .hljs-emphasis {
            font-style: italic;
        }
        .hljs-strong {
            font-weight: bold;
        }
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(229, 88, 101, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(229, 88, 101, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(229, 88, 101, 0);
            }
        }
        @keyframes rotateGear {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        @keyframes reverseRotateGear {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(-360deg);
            }
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes rotate {
            100% {
                transform: rotate(360deg);
            }
        }
        @keyframes loading {
            0% {
                background-position: -800px 0;
            }
            50% {
                background-position: 0px 0;
            }
            100% {
                background-position: 800px 0;
            }
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .loading-spinner {
            display: inline-block;
        }
        .bx-spin {
            animation: spin 1s linear infinite;
        }
        .session-name {
            flex-grow: 1;
        }
        .session-options {
            position: relative;
        }
        .options-trigger {
            cursor: pointer;
            padding: 2px;
            transform: rotate(90deg);
        }
@media (min-width: 768px) and (max-width: 1024px) {
    pre {
        font-size: 13px; /* Adjust font size only */
    }
    .code__language-label {
        font-size: 13px;
    }
    .code__copy-btn {
        font-size: 16px;
    }
}
        @media (min-width: 769px) {
            body:not(.hide-header) .greeting-container {
                display: block;
                position: absolute;
                top: 30%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            body.hide-header .greeting-container {
                display: none;
            }
            body:not(.hide-header) .prompt {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 600px;
                max-width: 90vw;
                border-radius: 10px;
                box-shadow: none;
            }
            body.hide-header .prompt {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
            }
        }
        @media (max-width: 768px) {
            .greeting-container h1 {
                    font-size: 1.8rem;
                    font-weight: 600;
            }
            .greeting-container h2 {
                        font-size: 1rem;
            }
            .welcome-title {
                font-size: 2rem;
            }
            .welcome-subtitle {
                font-size: 1rem;
            }
            .welcome-input {
                font-size: 1rem;
                padding: 0.8rem;
            }
            .welcome-button {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
            body:not(.hide-header) .greeting-container {
                display: block;
            }
            body.hide-header .greeting-container {
                display: none;
            }
            .prompt {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
            }
            #chatHistoryList {
                max-height: 250px;
            }
            .sidebar__body {
                margin-top: 0.2rem;
            }
            .sidebar__body-item {
                padding: 0.5rem;
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }
            .prompt__form-input {
                font-size: 1rem;
            }
            pre {
                font-size: 12px;
            }
            .code__language-label {
                font-size: 12px;
            }
            .code__copy-btn {
                font-size: 16px;
            }
            .navbar {
                padding: 0.25rem 1rem;
            }
            .chats .message__content {
                gap: 0.75rem;
                margin-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .chats .message--incoming {
                margin-top: 1rem;
            }
            .chats .message--outgoing:not(:first-child) {
                margin-top: 1.5rem;
            }
            .chats .message__text {
                font-size: 1rem;
                line-height: 1.4;
            }
            .chats .message--outgoing .message__text {
                font-size: 1rem;
                line-height: 1.4;
            }
            .chats {
                margin-top: 0px;
            }
            th,
            td {
                width: auto;
                padding: 8px;
                font-size: 12px;
            }
            .scroll-button {
                font-size: 16px;
                padding: 8px 12px;
            }
            .popup {
                width: 80%;
                max-width: 480px;
            }
            .popup__left {
                flex: 0 0 160px;
                padding: 0.75rem;
            }
            .popup__right {
                padding: 0.75rem;
            }
            .popup__button {
                padding: 0.35rem;
                font-size: 0.85rem;
            }
            .popup__close {
                font-size: 1.2rem;
                top: 10px;
                right: 10px;
            }
            .delete-button,
            #saveButton {
                padding: 0.35rem 0.7rem;
                font-size: 0.85rem;
            }
            .profile-image-wrapper {
                width: 60px;
                height: 60px;
            }
            .edit-icon {
                font-size: 1rem;
            }
            .username-container .edit-icon {
                right: 0px;
            }
            .chats .message__content {
                gap: 0.5rem;
            }
            .navbar__new-chat {
                font-size: 1.25rem;
            }
        }
        @media (max-width: 480px) {
            .greeting-container h1 {
                    font-size: 1.7rem;
                    font-weight: 600;
            }
            .greeting-container h2 {
                        font-size: 0.9rem;
            }
            .chats .message--incoming {
                margin-top: 0.85rem;
            }
            .chats .message--outgoing:not(:first-child) {
                margin-top: 1.3rem;
            }
            .chats .message__text {
                font-size: 1rem;
                line-height: 1.5;
            }
            .chats .message--outgoing .message__text {
                font-size: 1rem;
                line-height: 1.5;
            }
            .message--thinking .reasoning-container {
                margin-left: 0;
                margin-right: auto;
                max-width: 824px;
            }
            .think-badge {
                background-color: var(--accent-color);
                color: white;
                padding: 0.2rem 0.5rem;
                border-radius: 4px;
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
                display: inline-block;
            }
            #chatHistoryList {
                max-height: 220px;
            }
            .popup {
                width: 95%;
                max-width: 95%;
                top: 50%;
                transform: translate(-50%, -50%);
                height: auto;
                border-radius: 8px;
            }
            .popup__container {
                flex-direction: row;
                flex-wrap: nowrap;
                height: auto;
            }
            .popup__left {
                flex: 0 0 120px;
                padding: 0.5rem;
                height: auto;
                overflow-y: auto;
            }
            .popup__right {
                flex: 1;
                padding: 0.5rem;
                overflow-y: auto;
                height: auto;
            }
            .popup__close {
                font-size: 1.1rem;
                top: 5px;
                right: 5px;
            }
            .delete-button,
            #saveButton {
                padding: 0.35rem 0.7rem;
                font-size: 0.85rem;
            }
            .profile-image-wrapper {
                width: 60px;
                height: 60px;
            }
            .edit-icon {
                font-size: 1rem;
            }
            .username-container .edit-icon {
                right: 0px;
            }
            .chats .message__content {
                gap: 0.5rem;
            }
            .navbar__new-chat {
                font-size: 1rem;
            }
        }
        @media screen and (max-width: 980px) {
            .header {
                padding: 0 2rem;
            }
            .header__title {
                line-height: 2.8rem;
            }
            .header__title h1 {
                font-size: 2.7rem;
            }
            .header__title h2 {
                font-size: 2.5rem;
            }
            .message {
                padding: 0 1.5rem;
            }
        }
        .chats .message--image {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        .chats .message--image.message--incoming {
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .chats .message--image-loading .message__content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 0;
        }
        .chats .message--image-loading .image-loading-message {
            margin-bottom: 5px;
            align-self: flex-start;
        }
        .message--image .image-edit-btn {
            display: none;
        }
        .message--image.last-image .image-edit-btn {
            display: inline-block;
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: var(--secondary-color);
            color: var(--text-color);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 250px;
            max-width: 400px;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 2.7s;
            animation-fill-mode: forwards;
            border-left: 4px solid var(--accent-color);
        }
        .toast.success {
            border-left-color: var(--success-color);
        }
        .toast.error {
            border-left-color: var(--error-color);
        }
        .toast.warning {
            border-left-color: #ff9800;
        }
        .toast-icon {
            font-size: 20px;
        }
        .toast-message {
            flex: 1;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        /* Improved Settings Popup */
        .popup__tabs {
            display: flex;
            border-bottom: 1px solid var(--input-border-color);
            margin-bottom: 1rem;
        }
        .popup__tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            color: var(--text-secondary-color);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.3s ease;
            border-bottom: 2px solid transparent;
            flex: 1;
            text-align: center;
        }
        .popup__tab.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
        .popup__tab:hover {
            color: var(--text-color);
        }
        .popup__tab-content {
            display: none;
        }
        .popup__tab-content.active {
            display: block;
        }
        #themeSelector {
            width: 100%;
            max-width: 300px;
            padding: 0.75rem;
            font-size: 1rem;
            color: var(--text-color);
            background-color: var(--secondary-color);
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }
        #themeSelector:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: var(--focus-color);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        #themeSelector option {
            background-color: var(--secondary-color);
            color: var(--text-color);
            font-size: 1rem;
            padding: 0.5rem;
        }
        #themeSelector:hover {
            background-color: var(--secondary-hover-color);
            border-color: var(--accent-hover);
        }
        .settings-section {
            margin-bottom: 1.5rem;
        }
        .settings-section h3 {
            margin-bottom: 1rem;
            color: var(--text-color);
            font-size: 1.2rem;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--primary-color);
            transition: background 0.3s ease;
        }
        .settings-item:hover {
            background: var(--secondary-hover-color);
        }
        .settings-item-label {
            font-weight: 500;
        }
        .settings-item-control {
            display: flex;
            align-items: center;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--secondary-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .toggle-switch.active {
            background: var(--accent-color);
        }
        .toggle-switch-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .toggle-switch.active .toggle-switch-slider {
            transform: translateX(26px);
        }
        /* Full-page settings modal */
        .settings-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .settings-page.active {
            display: flex;
        }
      
        .settings-header {
            padding: 1rem 2rem;
            background: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .settings-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        .settings-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        .settings-close:hover {
            background: var(--secondary-hover-color);
        }
        .settings-content {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .settings-content::-webkit-scrollbar {
        display: none;
    }
        .settings-section {
            margin-bottom: 2rem;
        }
        .settings-section h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--text-color);
            border-bottom: 1px solid var(--input-border-color);
            padding-bottom: 0.5rem;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--secondary-color);
            transition: background 0.3s ease;
        }
        .settings-item:hover {
            background: var(--secondary-hover-color);
        }
        .settings-item-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .settings-item-control {
            display: flex;
            align-items: center;
        }
        .settings-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }
        .settings-button:hover {
            background: var(--accent-hover);
        }
        .settings-button.delete {
            background: var(--error-color);
        }
        .settings-button.delete:hover {
            background: #e04444;
        }
        @media (max-width: 768px) {
            .settings-header {
                padding: 1rem;
            }
            .settings-content {
                padding: 1rem;
            }
            .settings-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .settings-item-control {
                width: 100%;
                justify-content: flex-end;
            }
        }
    @keyframes move-border {
        0% {
            background-position: 0% 0%;
        }
        100% {
            background-position: 400% 0%;
        }
    }
    .settings-section.highlight::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        z-index: -1;
        border-radius: 12px;
        background: linear-gradient(
            90deg,
            var(--secondary-hover-color),
            transparent,
            var(--secondary-hover-color),
            transparent,
            var(--secondary-hover-color)
        );
        background-size: 400% 100%;
        background-repeat: repeat;
        animation: move-border 4s linear infinite;
    }
    .settings-section.highlight {
        position: relative;
        z-index: 1;
        border-radius: 10px;
        overflow: hidden;
    }
        .code-block-wrapper {
        position: relative;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
    }
    .code-block-header {
        position: sticky;
        top: 0;
        background: var(--code-block-lebal-color);
        padding: 0.5rem 1rem;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 10;
        border: 1px solid var(--code-block-border-color);
        border-bottom: none;
        font-size: 0.9rem; /* Slightly smaller for balance */
    }
        .code-block-header .code__language-label {
            position: static;
            margin: 0;
        }
        .code-block-header .icons-group {
            display: flex;
            gap: 20px; /* Reduced spacing */
            align-items: center;
        }
        .code-block-header .code__copy-btn {
            position: static;
            margin: 0;
            margin-left: 2px; /* Reduced spacing */
        }
        .code-block-header button {
            margin-left: 2px; /* Reduced spacing */
        }
        /* Settings Improvements */
        .settings-section {
            margin-bottom: 1.5rem;
        }
        .settings-section h3 {
            margin-bottom: 1rem;
            color: var(--text-color);
            font-size: 1.2rem;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--primary-color);
            transition: background 0.3s ease;
        }
        .settings-item:hover {
            background: var(--secondary-hover-color);
        }
        .settings-item-label {
            font-weight: 500;
        }
        .settings-item-control {
            display: flex;
            align-items: center;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--secondary-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .toggle-switch.active {
            background: var(--accent-color);
        }
        .toggle-switch-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .toggle-switch.active .toggle-switch-slider {
            transform: translateX(26px);
        }
        /* Full-page settings modal */
        .settings-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .settings-page.active {
            display: flex;
        }
      
        .settings-header {
            padding: 1rem 2rem;
            background: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .settings-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        .settings-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        .settings-close:hover {
            background: var(--secondary-hover-color);
        }
        .settings-content {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .settings-content::-webkit-scrollbar {
        display: none;
    }
        .settings-section {
            margin-bottom: 2rem;
        }
        .settings-section h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--text-color);
            border-bottom: 1px solid var(--input-border-color);
            padding-bottom: 0.5rem;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--secondary-color);
            transition: background 0.3s ease;
        }
        .settings-item:hover {
            background: var(--secondary-hover-color);
        }
        .settings-item-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .settings-item-control {
            display: flex;
            align-items: center;
        }
        .settings-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }
        .settings-button:hover {
            background: var(--accent-hover);
        }
        .settings-button.delete {
            background: var(--error-color);
        }
        .settings-button.delete:hover {
            background: #e04444;
        }
        @media (max-width: 768px) {
            .settings-header {
                padding: 1rem;
            }
            .settings-content {
                padding: 1rem;
            }
            .settings-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            .settings-item-control {
                width: 100%;
                justify-content: flex-end;
            }
        }
    @keyframes move-border {
        0% {
            background-position: 0% 0%;
        }
        100% {
            background-position: 400% 0%;
        }
    }
    .settings-section.highlight::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        z-index: -1;
        border-radius: 12px;
        background: linear-gradient(
            90deg,
            var(--secondary-hover-color),
            transparent,
            var(--secondary-hover-color),
            transparent,
            var(--secondary-hover-color)
        );
        background-size: 400% 100%;
        background-repeat: repeat;
        animation: move-border 4s linear infinite;
    }
    .settings-section.highlight {
        position: relative;
        z-index: 1;
        border-radius: 10px;
        overflow: hidden;
    }
    .code-block-wrapper .code-block-header button {
        margin-left: 2px; /* Reduced spacing */
    }
    .code-preview-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        padding: 20px;
    }
    .code-preview-overlay.show {
        display: flex;
    }
    .code-preview-header {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: var(--secondary-color);
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .code-preview-title {
        color: var(--text-color);
        font-size: 1.2rem;
    }
    .code-preview-close {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 1.5rem;
        cursor: pointer;
    }
    .code-preview-iframe {
        width: 100%;
        height: calc(100% - 40px);
        border: none;
        margin-top: 40px;
        background: white; /* Reset to white background */
        color: black; /* Black text */
    }
    </style>
</head>
<body>
    <script>
        (function() {
            const savedTheme = localStorage.getItem("theme") || "system";
            if (savedTheme === "system") {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.body.classList.add(prefersDark ? "dark_mode" : "light_mode");
            } else {
                document.body.classList.add(savedTheme + "_mode");
            }
        })();
    </script>
    <div id="welcomeScreen" class="welcome-screen">
        <h1 class="welcome-title">Welcome to Byte Ai</h1>
        <p class="welcome-subtitle">Before we begin, what should we call you?</p>
        <span id="usernameStatus" style="font-size: 0.9rem;">0/12</span>
        <input type="text" id="welcomeNameInput" class="welcome-input" placeholder="Enter your name" maxlength="12">
        <button id="welcomeSubmitButton" class="welcome-button">Let's Start</button>
    </div>
    <div id="loadingOverlay" class="loading-overlay">
        <i class="fa-solid fa-spinner loading-spinner"></i>
    </div>
    <div id="overlay" class="overlay"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar__header">BYTE</div>
        <div class="sidebar__body">
            <button class="new-chat-button" onclick="prepareNewChat()">
                <i class='bx bxs-edit'></i>
                <span>New Chat</span>
            </button>
            <hr>
            <div id="chatHistoryList" class="sidebar__body-item">
            </div>
            <br>
        </div>
        <div class="sidebar__footer">
            <div class="sidebar__body-item" onclick="openSettings()">Settings</div>
            <p>&copy; 2024 Time Load</p>
        </div>
    </div>
    <div class="confirmation_popup">
        <i class="fas fa-exclamation-triangle"></i>
        <h1 class="confirmation_message">Your account will be deleted permanently!</h1>
        <p class="confirmation_description">Are you sure you want to proceed?</p>
       <div class="confirmation_buttons">
            <button class="cancel_button" onclick="cancelPopup()">Cancel</button>
            <button class="confirm_button" onclick="confirmAction()">Confirm</button>
        </div>
    </div>
    <!-- Full-page Settings Modal -->
    <div id="settingsPage" class="settings-page">
        <div class="settings-header">
            <h1 class="settings-title">Settings</h1>
            <button class="settings-close" onclick="closeSettings()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h2>Personalization</h2>
                <div class="profile-image-container">
                    <input type="file" id="profileImageUpload" accept="image/*" onchange="previewImage(event)" style="display: none;">
                    <div class="profile-image-wrapper" onclick="document.getElementById('profileImageUpload').click()">
                        <img id="profileImagePreview" src="../static/images/user.webp" alt="User avatar">
                        <div class="editimage">
                            <i class="edit-icon">✎</i>
                        </div>
                    </div>
                </div>
                <div id="imageGallery" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                <label for="username" class="label">User Name:</label>
                <div class="username-container">
                    <input type="text" id="username" class="input-field" disabled placeholder="Enter your username">
                    <div class="edit-overlay" onclick="enableEdit('username')">
                        <span class="edit-icon">🖉</span>
                    </div>
                </div>
                <label for="dob" class="label">Date of Birth:</label>
                <input type="date" id="dob" class="date-field">
                <button id="saveButton" onclick="saveUserProfile()" disabled class="save-button">Save</button>
            </div>
            <div class="settings-section">
                <h2>Theme</h2>
                <div class="settings-item">
                    <span class="settings-item-label">Theme</span>
                    <div class="settings-item-control">
                        <select id="themeSelector">
                            <option value="byte">Byte</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="system">System</option>
                            <option value="aurora_night">Aurora Night</option>
                            <option value="midnight_tech">Midnight Tech</option>
                            <option value="warm_dusk">Warm Dusk</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h2>Chat Settings</h2>
                <div class="settings-item">
                    <span class="settings-item-label">Delete Chat History</span>
                    <div class="settings-item-control">
                        <button class="settings-button delete" onclick="showConfirmationPopup('Your Chat History will be deleted Permanently!', 'clearChats')">Clear Chats</button>
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <h2>Browser Data</h2>
                <div class="settings-item">
                    <span class="settings-item-label">Clear Data</span>
                    <div class="settings-item-control">
                        <button class="settings-button delete" onclick="showConfirmationPopup('Your Browser Data will be deleted Permanently!', 'clearBrowserData')">Clear Data</button>
                    </div>
                </div>
                <div class="settings-item">
                    <span class="settings-item-label">Clear Cache</span>
                    <div class="settings-item-control">
                        <button class="settings-button delete" onclick="showConfirmationPopup('Your Browser Cache will be deleted Permanently!', 'clearCache')">Clear Cache</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <header class="navbar">
        <button id="sidebarToggler">
            <i class="fa-solid fa-spinner sidebar-toggler-icon"></i>
        </button>
        <div class="navbar__spacer"></div>
        <div class="navbar__right">
            <button id="newChatButton" class="navbar__new-chat" aria-label="Start new chat" onclick="prepareNewChat()">
                <i class="far fa-comment"></i>
            </button>
            <div class="navbar__user">
                <img id="userProfileIcon" src="../static/images/user.webp" alt="User Avatar" class="navbar__user-image">
                <div class="sub-menu-wrap" id="subMenu">
                    <div class="sub-menu">
                        <div class="user-info">
                            <img src="../static/images/user.webp" id="subMenuUserProfile" alt="User Profile Image">
                            <h2 id="subMenuUser">User</h2>
                        </div>
                        <hr>
                        <a href="#" class="sub-menu-link" onclick="editProfile()">
                            <i class="fas fa-user-edit"></i>
                            <p>Edit Profile</p>
                            <span>></span>
                        </a>
                        <a href="#" class="sub-menu-link" onclick="openSettings()">
                            <i class="fas fa-cog"></i>
                            <p>Settings</p>
                            <span>></span>
                        </a>
                        <a href="#" class="sub-menu-link" onclick="edittheme()">
                            <i class="fas fa-paint-brush"></i>
                            <p>theme</p>
                            <span>></span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <section class="chats"><h2 style=" display: none;">Byte Ai</h2></section>
    <button id="scrollToBottomButton" class="scroll-button" onclick="scrollToBottom()" aria-label="Scroll to bottom">
        <i class="bx bx-down-arrow-alt"></i>
    </button>
    <div class="greeting-container">
        <h1 id="greeting">Hello, User!</h1>
        <h2>How can I help you today?</h2>
    </div>
    <section class="prompt">
        <h2 class="prompt__heading visually-hidden">Ask Your Question</h2>
        <form action="#" class="prompt__form" novalidate>
            <div class="prompt__input-wrapper">
                <textarea id="chat-input" placeholder="What do you want to know?" class="prompt__form-input" required></textarea>
                <div class="prompt__bottom-row">
                    <div class="prompt__options-row">
                        <div class="prompt__option" data-option="webSearch" onclick="toggleOption(this)">
                            <i class='bx bx-globe'></i>
                            <span>Search</span>
                        </div>
                        <div class="prompt__option" data-option="deepThink" onclick="toggleOption(this)">
                            <i class='bx bx-atom'></i>
                            <span>Think</span>
                        </div>
                        <div class="prompt__option" data-option="imageGeneration" onclick="toggleOption(this)">
                            <i class='bx bx-image'></i>
                            <span>Image</span>
                        </div>
                    </div>
                    <div class="prompt__buttons-left">
                        <button class="prompt__form-button" id="sendButton" aria-label="Send message">
                            <i class='bx bx-up-arrow-alt'></i>
                        </button>
                        <button class="prompt__form-button" id="pauseButton" style="display: none;">
                            <i class='bx bx-stop'></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </section>
    <div id="imageOverlay" class="image-overlay">
        <div class="image-overlay-content">
            <img id="overlayImage" src="" alt="Generated Image">
            <div class="image-overlay-actions">
                <button class="image-overlay-btn image-download-btn" onclick="downloadOverlayImage()" title="Download Image">
                    <i class='bx bx-download'></i>
                </button>
                <button class="image-overlay-btn image-edit-btn" onclick="editOverlayImage()" title="Edit Image">
                    <i class='bx bx-pencil'></i>
                </button>
                <button class="image-overlay-btn image-overlay-close" onclick="closeImageOverlay()" title="Close">
                    <i class='bx bx-x'></i>
                </button>
            </div>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>
    <div id="codePreviewOverlay" class="code-preview-overlay">
        <div class="code-preview-header">
            <span class="code-preview-title">Preview</span>
            <button class="code-preview-close" onclick="closeCodePreview()">
                <i class='bx bx-x'></i>
            </button>
        </div>
        <iframe id="codePreviewIframe" class="code-preview-iframe"></iframe>
    </div>
    <script src="https://unpkg.com/compromise@latest/builds/compromise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7343191328520430"
     crossorigin="anonymous"></script>
     <script>
         const messageForm = document.querySelector(".prompt__form");
        const chatHistoryContainer = document.querySelector(".chats");
        const chatHistoryList = document.getElementById("chatHistoryList");
        const scrollToBottomButton = document.getElementById("scrollToBottomButton");
        const chatInput = document.getElementById("chat-input");
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const sidebarToggler = document.getElementById('sidebarToggler');
        const suggestions = document.querySelectorAll(".suggestion-list .suggestion");
        const micButton = document.getElementById('micButton');
        const pauseButton = document.getElementById("pauseButton");
        const inputField = document.querySelector('.prompt__form-input');
        const sendButton = document.querySelector('#sendButton');
        const imageOverlay = document.getElementById('imageOverlay');
        const overlayImage = document.getElementById('overlayImage');
        let chatSessions = JSON.parse(localStorage.getItem("chatSessions")) || [];
        let currentSessionId = null;
        let currentUserMessage = null;
        let isGeneratingResponse = false;
        let optionsState = {
            webSearch: false,
            deepThink: false,
            imageGeneration: false,
            imageModification: false,
        };
        let previousProfileImage = localStorage.getItem('profileImage') || "../static/images/user.webp";
        let previousUserName = localStorage.getItem('username') || "";
        let previousDOB = localStorage.getItem('dob') || "";
        let tempProfileImage = null;
        let tempProfileImageId = null;
        let tempUserName = null;
        let tempDOB = null;
        let currentUtterance = null;
        let touchStartY = 0;
        let db;
        const imageGenerationKeywords = [
            "/image", "/imagine", "/draw", "create an image", "draw", "generate image", "create image", "make image", "image of",
            "picture of", "photo of", "visualize", "show me", "illustration",
            "design", "art", "graphic", "render", "sketch", "create a", "make a"
        ];
        const imageModificationKeywords = [
            "modify", "change", "edit", "adjust", "alter", "update", "revise",
            "improve", "enhance", "fix", "correct", "redo", "remake", "regenerate",
            "different version", "another version", "try again", "make it",
            "change the", "modify the", "edit the", "adjust the", "again", "different"
        ];
        const loadingMessages = [
            "Got it! Generating the image for you…",
            "On it! Creating that image now.",
            "Here comes your image, just a moment…"
        ];
        const successMessages = [
            "Image created successfully.",
            "Done! Your image is ready.",
            "Here's your image!",
            "Image generation complete."
        ];
        chatHistoryContainer.addEventListener('click', function(e) {
            const target = e.target.closest('.message__icon');
            if (target) {
                if (target.classList.contains('copy')) {
                    copyMessageToClipboard(target);
                } else if (target.classList.contains('edit')) {
                    editMessage(target);
                } else if (target.classList.contains('like')) {
                    toggleLikeDislike(target, 'like');
                } else if (target.classList.contains('dislike')) {
                    toggleLikeDislike(target, 'dislike');
                }
            } else if (e.target.classList.contains('edit-message-cancel')) {
                cancelEdit(e.target);
            } else if (e.target.classList.contains('edit-message-submit')) {
                submitEditedMessage(e.target);
            } else if (e.target.classList.contains('image-download-btn')) {
                downloadImage(e.target);
            } else if (e.target.classList.contains('image-edit-btn')) {
                editImage(e.target);
            } else if (e.target.classList.contains('generated-image')) {
                openImageOverlay(e.target);
            }
        });
        async function initializeDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open("userProfileDB", 2);
        request.onupgradeneeded = function(event) {
            const db = event.target.result;
            console.log(`Upgrading database from version ${event.oldVersion} to ${event.newVersion}`);
            if (event.oldVersion < 1) {
                if (!db.objectStoreNames.contains("profileImages")) {
                    console.log("Creating profileImages object store");
                    db.createObjectStore("profileImages", { keyPath: "id", autoIncrement: true });
                }
            }
            if (event.oldVersion < 2) {
                if (!db.objectStoreNames.contains("chatImages")) {
                    console.log("Creating chatImages object store");
                    db.createObjectStore("chatImages", { keyPath: "id", autoIncrement: true });
                }
            }
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            console.log("Database initialized successfully");
            console.log("Object stores:", Array.from(db.objectStoreNames));
            resolve(db);
        };
        request.onerror = function(event) {
            console.error("Database error:", event.target.error);
            reject(event.target.error);
        };
    });
}
        async function saveChatImageToDB(blob) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["chatImages"], "readwrite");
                const objectStore = transaction.objectStore("chatImages");
                const data = {
                    image: blob,
                    timestamp: Date.now()
                };
                const request = objectStore.add(data);
                request.onsuccess = function(event) {
                    resolve(event.target.result);
                };
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        async function getChatImageById(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["chatImages"], "readonly");
                const objectStore = transaction.objectStore("chatImages");
                const request = objectStore.get(id);
                request.onsuccess = function(event) {
                    const result = event.target.result;
                    if (result && result.image) {
                        resolve(URL.createObjectURL(result.image));
                    } else {
                        resolve(null);
                    }
                };
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        async function deleteChatImageById(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(["chatImages"], "readwrite");
                const objectStore = transaction.objectStore("chatImages");
                const request = objectStore.delete(id);
                request.onsuccess = function(event) {
                    resolve();
                };
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                await initializeDB();
                const hasVisitedBefore = getCookie('byte_visited') || localStorage.getItem('username');
                const welcomeScreen = document.getElementById('welcomeScreen');
                const welcomeNameInput = document.getElementById('welcomeNameInput');
                const welcomeSubmitButton = document.getElementById('welcomeSubmitButton');
                document.body.classList.remove('hide-header');
                if (hasVisitedBefore) {
                    welcomeScreen.classList.add('hidden');
                    document.getElementById("loadingOverlay").style.display = "none";
                } else {
                    document.getElementById("loadingOverlay").style.display = "none";
                    welcomeScreen.classList.remove('hidden');
                    welcomeSubmitButton.addEventListener('click', () => {
                        const userName = welcomeNameInput.value.trim();
                        if (userName) {
                            localStorage.setItem('username', userName);
                            setCookie('byte_visited', 'true', 365);
                            document.getElementById('subMenuUser').textContent = userName;
                            document.getElementById('greeting').textContent = `Hello, ${userName}!`;
                            welcomeScreen.classList.add('hidden');
                        }
                    });
                    welcomeNameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            welcomeSubmitButton.click();
                        }
                    });
                }
                const savedTheme = localStorage.getItem("theme") || "system";
                themeSelector.value = savedTheme;
                applyTheme(savedTheme);
                initializeChatSessions();
                const defaultImage = "../static/images/user.webp";
                const profileImagePreview = document.getElementById("profileImagePreview");
                const userProfileIcon = document.getElementById("userProfileIcon");
                const subMenuUserProfile = document.getElementById("subMenuUserProfile");
                if (profileImagePreview) profileImagePreview.src = defaultImage;
                if (userProfileIcon) userProfileIcon.src = defaultImage;
                if (subMenuUserProfile) subMenuUserProfile.src = defaultImage;
                const savedUsername = localStorage.getItem('username') || "User";
                const greetingText = document.getElementById("greeting");
                if (greetingText) greetingText.textContent = `Hello, ${savedUsername}!`;
                const savedDOB = localStorage.getItem('dob') || "";
                const usernameField = document.getElementById("username");
                const dobField = document.getElementById("dob");
                const subMenuUser = document.getElementById("subMenuUser");
                if (subMenuUser) subMenuUser.textContent = savedUsername || "User";
                if (usernameField) {
                    usernameField.value = savedUsername;
                    usernameField.disabled = !!savedUsername;
                    const editIcon = document.querySelector('.username-container .edit-icon');
                    if (editIcon) {
                        editIcon.style.display = savedUsername ? 'block' : 'none';
                    }
                }
                if (dobField) dobField.value = savedDOB;
                const currentImageId = Number(localStorage.getItem("currentProfileImageId"));
                if (currentImageId) {
                    try {
                        const savedProfileImage = await getProfileImageById(currentImageId);
                        if (savedProfileImage) {
                            if (profileImagePreview) profileImagePreview.src = savedProfileImage;
                            if (userProfileIcon) userProfileIcon.src = savedProfileImage;
                            if (subMenuUserProfile) subMenuUserProfile.src = savedProfileImage;
                            previousProfileImage = savedProfileImage;
                        }
                    } catch (error) {
                        console.error("Failed to load profile image from IndexedDB:", error);
                    }
                }
            } catch (error) {
                console.error("Initialization error:", error);
                document.getElementById("loadingOverlay").style.display = "none";
            }
            renderMathInElement(document.body, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                ]
            });
        });
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (event) => {
            const savedTheme = localStorage.getItem("theme");
            if (savedTheme === "system") {
                applyTheme("system");
            }
        });
        window.onload = async function() {
            try {
                document.getElementById("loadingOverlay").style.display = "none";
                const db = await window.dbPromise;
                const defaultImage = "../static/images/user.webp";
                const profileImagePreview = document.getElementById("profileImagePreview");
                const userProfileIcon = document.getElementById("userProfileIcon");
                const subMenuUserProfile = document.getElementById("subMenuUserProfile");
                if (profileImagePreview) profileImagePreview.src = defaultImage;
                if (userProfileIcon) userProfileIcon.src = defaultImage;
                if (subMenuUserProfile) subMenuUserProfile.src = defaultImage;
                previousProfileImage = defaultImage;
                const savedUsername = localStorage.getItem('username') || "User";
                const greetingText = document.getElementById("greeting");
                if (greetingText) greetingText.textContent = `Hello, ${savedUsername}!`;
                const savedDOB = localStorage.getItem('dob') || "";
                const usernameField = document.getElementById("username");
                const dobField = document.getElementById("dob");
                const subMenuUser = document.getElementById("subMenuUser");
                if (subMenuUser) subMenuUser.textContent = savedUsername || "User";
                if (usernameField) {
                    usernameField.value = savedUsername;
                    usernameField.disabled = !!savedUsername;
                    const editIcon = document.querySelector('.username-container .edit-icon');
                    if (editIcon) {
                        editIcon.style.display = savedUsername ? 'block' : 'none';
                    }
                }
                if (dobField) dobField.value = savedDOB;
                const currentImageId = Number(localStorage.getItem("currentProfileImageId"));
                if (currentImageId) {
                    try {
                        const savedProfileImage = await getProfileImageById(currentImageId);
                        console.log("Profile image URL:", savedProfileImage);
                        const profileImage = savedProfileImage || defaultImage;
                        if (profileImagePreview) profileImagePreview.src = profileImage;
                        if (userProfileIcon) userProfileIcon.src = profileImage;
                        if (subMenuUserProfile) subMenuUserProfile.src = profileImage;
                        previousProfileImage = profileImage;
                    } catch (error) {
                        console.error("Failed to load profile image from IndexedDB:", error);
                    }
                }
                listAllImages();
            } catch (error) {
                console.error("Window onload error:", error);
                document.getElementById("loadingOverlay").style.display = "none";
            }
        };
        document.addEventListener("storage", (event) => {
            if (event.key === 'chatSessions') {
                chatSessions = JSON.parse(event.newValue) || [];
                loadChatSessions();
                if (currentSessionId) {
                    loadChatHistory(currentSessionId);
                }
            }
        });
        themeSelector.addEventListener("change", () => {
            const selectedTheme = themeSelector.value;
            localStorage.setItem("theme", selectedTheme);
            applyTheme(selectedTheme);
        });
        sidebarToggler.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSidebar();
        });
        overlay.addEventListener('click', () => {
            closeSidebar();
        });
        sidebar.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        chatInput.addEventListener("input", () => {
    chatInput.style.height = "60px";
    const newHeight = Math.min(chatInput.scrollHeight, 225);
    chatInput.style.height = newHeight + "px";
    const message = chatInput.value.toLowerCase().trim();
    const words = message.split(/\s+/);
    const firstFewWords = words.slice(0, 3).join(' ');
    function startsWithImageGenerationKeyword() {
        const firstWord = words[0];
        return imageGenerationKeywords.some(keyword => {
            if (keyword.startsWith('/')) {
                return message.startsWith(keyword);
            }
            return firstFewWords.startsWith(keyword);
        });
    }
    const isImageRequest = imageGenerationKeywords.some(keyword => message.startsWith(keyword));
    const isModificationRequest = imageModificationKeywords.some(keyword => message.startsWith(keyword));
    const hasImageContext = trackImageContext();
    if (startsWithImageGenerationKeyword()) {
        const imageOption = document.querySelector('[data-option="imageGeneration"]');
        if (imageOption) toggleOption(imageOption);
        optionsState.imageGeneration = true;
        optionsState.imageModification = false;
    } else if (isModificationRequest && hasImageContext) {
        const imageOption = document.querySelector('[data-option="imageGeneration"]');
        if (imageOption) toggleOption(imageOption);
        optionsState.imageGeneration = true;
        optionsState.imageModification = true;
    } else if (isImageRequest) {
        const imageOption = document.querySelector('[data-option="imageGeneration"]');
        if (imageOption) toggleOption(imageOption);
        optionsState.imageGeneration = true;
        optionsState.imageModification = false;
    } else if (message.startsWith("image") && hasImageContext) {
        const imageOption = document.querySelector('[data-option="imageGeneration"]');
        if (imageOption) toggleOption(imageOption);
        optionsState.imageGeneration = true;
        optionsState.imageModification = true;
    } else {
        optionsState.imageGeneration = false;
        optionsState.imageModification = false;
        const imageOption = document.querySelector('[data-option="imageGeneration"]');
        if (imageOption) imageOption.classList.remove('selected');
    }
});
function analyzePromptForMixedIntents(prompt) {
    // Check if the prompt contains multiple distinct requests
    // A request is considered distinct if it contains an image generation keyword
    const lowerPrompt = prompt.toLowerCase();
    const imageKeywordsFound = imageGenerationKeywords.filter(keyword => lowerPrompt.startsWith(keyword));
    // If no image keywords are found, treat the entire prompt as a single request
    if (imageKeywordsFound.length === 0) {
        return [{ text: prompt, isImageRequest: false }];
    }
    // If image keywords are found, split the prompt and check each part
    const parts = prompt.split(/,\s*/).map(part => part.trim());
    const requests = [];
    parts.forEach(part => {
        const lowerPart = part.toLowerCase();
        const isImagePart = imageGenerationKeywords.some(keyword => lowerPart.startsWith(keyword));
        requests.push({ text: part, isImageRequest: isImagePart });
    });
    return requests;
}
messageForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (isGeneratingResponse) return;
    const prompt = chatInput.value.trim();
    const requests = analyzePromptForMixedIntents(prompt);
    if (requests.length > 1) {
        requests.forEach((request, index) => {
            setTimeout(() => {
                currentUserMessage = request.text;
                optionsState.imageGeneration = request.isImageRequest;
                optionsState.imageModification = false;
                resetTextareaHeight();
                chatInput.value = '';
                sendButton.style.opacity = '0.5';
                sendButton.style.pointerEvents = 'none';
                pauseButton.style.display = "block";
                sendButton.style.display = "none";
                handleOutgoingMessage();
                setTimeout(displayLoadingAnimation, 500);
            }, index * 2000);
        });
    } else {
        currentUserMessage = prompt;
        const submitOptions = { ...optionsState };
        resetTextareaHeight();
        chatInput.value = '';
        sendButton.style.opacity = '0.5';
        sendButton.style.pointerEvents = 'none';
        pauseButton.style.display = "block";
        sendButton.style.display = "none";
        handleOutgoingMessage();
        resetOptions();
        setTimeout(() => displayLoadingAnimation(submitOptions), 500);
    }
    pauseButton.addEventListener("click", () => {
        pauseButton.style.display = "none";
        sendButton.style.display = "block";
        if (currentUtterance) {
            window.speechSynthesis.cancel();
        }
    }, { once: true });
});
        const welcomeNameInput = document.getElementById('welcomeNameInput');
        const usernameStatus = document.getElementById('usernameStatus');
        welcomeNameInput.addEventListener('input', () => {
            const currentLength = welcomeNameInput.value.length;
            if (currentLength >= 12) {
                usernameStatus.textContent = 'Max 12 characters';
                usernameStatus.style.color = 'red';
                welcomeNameInput.classList.add('error');
            } else {
                usernameStatus.textContent = `${currentLength}/12`;
                usernameStatus.style.color = '';
                welcomeNameInput.classList.remove('error');
            }
        });
        document.addEventListener("DOMContentLoaded", () => {
            const userProfileIcon = document.querySelector('#userProfileIcon');
            if (userProfileIcon) {
                userProfileIcon.addEventListener('click', (e) => {
                    const subMenu = document.getElementById('subMenu');
                    if (subMenu) {
                        console.log('Toggling sub-menu');
                        subMenu.classList.toggle('open-menu');
                    }
                    e.stopPropagation();
                });
            }
        });
        document.addEventListener('click', (e) => {
            const subMenu = document.getElementById('subMenu');
            const userProfileIcon = document.getElementById('userProfileIcon');
            if (subMenu && !subMenu.contains(e.target) && userProfileIcon && !userProfileIcon.contains(e.target)) {
                console.log('Closing sub-menu');
                subMenu.classList.remove('open-menu');
            }
        });
        document.body.addEventListener('click', (e) => {
            console.log('Click target:', e.target);
            if (
                sidebar.classList.contains('open') &&
                !sidebar.contains(e.target) &&
                !sidebarToggler.contains(e.target)
            ) {
                console.log('Closing sidebar');
                closeSidebar();
            }
            if (e.target.id === 'userProfileIcon') {
                const subMenu = document.getElementById('subMenu');
                console.log('Toggling sub-menu');
                subMenu.classList.toggle('open-menu');
            } else if (!document.getElementById('subMenu').contains(e.target)) {
                console.log('Attempting to close sub-menu');
                document.getElementById('subMenu').classList.remove('open-menu');
            }
        });
        document.getElementById("username").addEventListener("input", enableSaveButton);
        document.getElementById("profileImageUpload").addEventListener("change", enableSaveButton);
        document.getElementById("username").addEventListener("blur", function() {
            const inputField = this;
            const editIcon = document.querySelector('.username-container .edit-icon');
            if (inputField.value && inputField.disabled) {
                if (editIcon) {
                    editIcon.style.display = 'inline';
                }
            }
        });
        document.getElementById("dob").addEventListener("input", enableSaveButton);
        document.querySelector('.username-container .edit-icon').addEventListener("click", function() {
            enableEdit("username");
        });
        inputField.addEventListener('input', () => {
            if (inputField.value.trim()) {
                sendButton.style.opacity = '1';
                sendButton.style.pointerEvents = 'auto';
            } else {
                sendButton.style.opacity = '0.5';
                sendButton.style.pointerEvents = 'none';
            }
        });
        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem('currentSessionId', currentSessionId);
        });
        chatHistoryContainer.addEventListener("scroll", updateScrollButtonVisibility);
        chatHistoryContainer.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });
        chatHistoryContainer.addEventListener('touchmove', (e) => {
            const touchCurrentY = e.touches[0].clientY;
            const touchDelta = touchCurrentY - touchStartY;
            if (Math.abs(touchDelta) > 5) {
                updateScrollButtonVisibility();
            }
        }, { passive: true });
        chatInput.addEventListener('keydown', (e) => {
            const isMobile = isMobileDevice();
            if (e.key === 'Enter' && !e.shiftKey) {
                if (isMobile) {
                    return;
                } else {
                    e.preventDefault();
                    if (chatInput.value.trim() && !isGeneratingResponse) {
                        messageForm.dispatchEvent(new Event('submit'));
                    }
                }
            }
            if (e.key === 'Enter' && e.shiftKey) {
                return;
            }
        });
const sanitizeInput = (input) => {
    if (typeof input !== 'string') return input;
    return input.replace(/[&<>"']/g, (match) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&apos;'
    })[match]);
};
function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = "expires=" + date.toUTCString();
    document.cookie = name + "=" + value + ";" + expires + ";path=/";
}
function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
    }
    return null;
}
function initializeChatSessions() {
    chatSessions = JSON.parse(localStorage.getItem("chatSessions")) || [];
    currentSessionId = sessionStorage.getItem('currentSessionId');
    if (currentSessionId && chatSessions.some(session => session.id === currentSessionId)) {
        loadChatHistory(currentSessionId);
    } else {
        currentSessionId = null;
        sessionStorage.removeItem('currentSessionId');
        clearChatHistory();
        document.body.classList.remove("hide-header");
    }
    loadChatSessions();
}
function prepareNewChat() {
    currentSessionId = null;
    sessionStorage.removeItem('currentSessionId');
    clearChatHistory();
    document.body.classList.remove("hide-header");
    closeSidebar();
    highlightCurrentSession();
}
function startNewChat(forceNew = false) {
    if (!forceNew) {
        prepareNewChat();
        return;
    }
    const newSession = {
        id: Date.now().toString(),
        name: "New Chat",
        chats: []
    };
    chatSessions.unshift(newSession);
    currentSessionId = newSession.id;
    sessionStorage.setItem('currentSessionId', currentSessionId);
    saveChatSessions();
    loadChatSessions();
    clearChatHistory();
    document.body.classList.remove("hide-header");
}
function saveChatSessions() {
    localStorage.setItem("chatSessions", JSON.stringify(chatSessions));
}
function loadChatSessions() {
    chatHistoryList.innerHTML = "";
    if (window.innerWidth <= 480) {
        chatHistoryList.style.maxHeight = "150px";
    } else if (window.innerWidth <= 768) {
        chatHistoryList.style.maxHeight = "200px";
    } else {
        chatHistoryList.style.maxHeight = "300px";
    }
    chatHistoryList.style.overflowY = "auto";
    chatSessions.forEach(session => {
        let sessionName = "New Chat";
        if (session.chats && session.chats.length > 0) {
            sessionName = session.chats[session.chats.length - 1].userInput;
        }
        const displayName = sessionName.length > 9 ? sessionName.substring(0, 9) + '..' : sessionName;
        const sessionItem = document.createElement("div");
        sessionItem.className = "sidebar__body-item";
        sessionItem.setAttribute('data-session-id', session.id); // Add session ID attribute
        sessionItem.innerHTML = `
            <div class="session-content">
                <span class="session-name">${displayName}</span>
                <div class="session-options">
                    <span class="options-trigger">⋮</span>
                    <div class="options-menu">
                        <div class="delete-option">Delete</div>
                    </div>
                </div>
            </div>
        `;
        sessionItem.addEventListener("click", (e) => {
            if (!e.target.closest('.session-options')) {
                loadChatHistory(session.id);
            }
        });
        const optionsTrigger = sessionItem.querySelector('.options-trigger');
        const optionsMenu = sessionItem.querySelector('.options-menu');
        const deleteOption = sessionItem.querySelector('.delete-option');
        optionsTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.options-menu').forEach(menu => {
                if (menu !== optionsMenu) {
                    menu.style.display = 'none';
                }
            });
            const isVisible = optionsMenu.style.display === 'block';
            optionsMenu.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                const rect = optionsTrigger.getBoundingClientRect();
                const menuWidth = 100;
                let leftPos = rect.left + window.scrollX - menuWidth;
                let topPos = rect.bottom + window.scrollY + 5;
                if (leftPos < 0) leftPos = 10;
                if (topPos + 50 > window.innerHeight + window.scrollY) {
                    topPos = rect.top + window.scrollY - 50;
                }
                optionsMenu.style.top = `${topPos}px`;
                optionsMenu.style.left = `${leftPos}px`;
            }
        });
        deleteOption.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteChatSession(session.id);
            optionsMenu.style.display = 'none';
        });
        chatHistoryList.appendChild(sessionItem);
    });
    highlightCurrentSession();
}
function highlightCurrentSession() {
    document.querySelectorAll('.sidebar__body-item').forEach(item => {
        item.classList.remove('selected');
        if (currentSessionId && item.getAttribute('data-session-id') === currentSessionId) {
            item.classList.add('selected');
        }
    });
}
function deleteChatSession(sessionId) {
    chatSessions = chatSessions.filter(session => session.id !== sessionId);
    saveChatSessions();
    loadChatSessions();
    if (currentSessionId === sessionId) {
        prepareNewChat();
    }
}
async function loadChatHistory(sessionId) {
    const session = chatSessions.find(session => session.id === sessionId);
    if (!session) return;
    currentSessionId = sessionId;
    sessionStorage.setItem('currentSessionId', currentSessionId);
    clearChatHistory();
    highlightCurrentSession();
    const hasChats = session.chats && session.chats.length > 0;
    document.body.classList.toggle("hide-header", hasChats);
    if (!hasChats) return;
    for (let index = 0; index < session.chats.length; index++) {
        const chat = session.chats[index];
        const isLastMessage = index === session.chats.length - 1;
        const outgoingMessageHtml = `
            <div class="message__content" style="display: flex; flex-direction: column; align-items: flex-end;">
                <p class="message__text">${sanitizeInput(chat.userInput)}</p>
                <div class="message__icons" style="display: flex; gap: 0.5rem;">
                    <span onClick="copyMessageToClipboard(this)" class="message__icon copy"><i class='bx bx-copy-alt'></i></span>
                    ${isLastMessage ? '<span onClick="editMessage(this)" class="message__icon edit"><i class="bx bx-pencil" ></i></span>' : ''}
                </div>
            </div>
        `;
        const outgoingMessageElement = createChatMessageElement(outgoingMessageHtml, "message--outgoing");
        chatHistoryContainer.appendChild(outgoingMessageElement);
        if (chat.aiResponse || chat.imageId) {
            let aiResponseHtml;
            if (chat.isImageGeneration && chat.imageId) {
                try {
                    const imageUrl = await getChatImageById(chat.imageId);
                    if (imageUrl) {
                        aiResponseHtml = `
                            <div class="image-container">
                                <img src="${imageUrl}" alt="Generated Image" class="generated-image" data-image-id="${chat.imageId}" data-prompt="${chat.prompt || ''}" onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\\'color: var(--error-color);\\'>Failed to load image. Please try again.</p>';">
                            </div>
                        `;
                    } else {
                        aiResponseHtml = '<p style="color: var(--error-color);">Image not found in storage.</p>';
                    }
                } catch (error) {
                    console.error('Error loading image from IndexedDB:', error);
                    aiResponseHtml = '<p style="color: var(--error-color);">Error loading image.</p>';
                }
            } else {
                aiResponseHtml = marked.parse(chat.aiResponse);
            }
            let iconsHtml;
            if (chat.isImageGeneration) {
                iconsHtml = `
                    <span onClick="downloadImage(this)" class="message__icon"><i class='bx bx-download'></i></span>
                    <span onClick="editImage(this)" class="message__icon image-edit-btn"><i class='bx bx-pencil'></i></span>
                    <span class="message__icon like"><i class='bx bx-like'></i></span>
                    <span class="message__icon dislike"><i class='bx bx-dislike'></i></span>
                `;
            } else {
                iconsHtml = `
                    <span onClick="copyMessageToClipboard(this)" class="message__icon"><i class='bx bx-copy-alt'></i></span>
                    <span class="message__icon like"><i class='bx bx-like'></i></span>
                    <span class="message__icon dislike"><i class='bx bx-dislike'></i></span>
                `;
            }
            const incomingMessageHtml = `
                <div class="message__content">
                    <div class="message__text">${aiResponseHtml}</div>
                </div>
                <div class="message__icons">
                    ${iconsHtml}
                </div>
            `;
            const incomingMessageElement = createChatMessageElement(incomingMessageHtml, "message--incoming");
            if (chat.isImageGeneration && chat.imageId) {
                incomingMessageElement.classList.add('message--image');
                if (index === session.chats.length - 1) {
                    incomingMessageElement.classList.add('last-image');
                }
            }
            incomingMessageElement.setAttribute('data-chat-index', index);
            chatHistoryContainer.appendChild(incomingMessageElement);
            const codeBlocks = incomingMessageElement.querySelectorAll("pre code");
            codeBlocks.forEach(block => hljs.highlightElement(block));
            addCopyButtonToCodeBlocks();
            if (chat.feedback === 'like') {
                incomingMessageElement.querySelector('.message__icon.like').classList.add('selected');
            } else if (chat.feedback === 'dislike') {
                incomingMessageElement.querySelector('.message__icon.dislike').classList.add('selected');
            }
            renderMathInElement(incomingMessageElement, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                ]
            });
        }
    }
    scrollToBottom();
    updateScrollButtonVisibility();
}
function createChatMessageElement(html, ...cssClasses) {
    const messageElement = document.createElement("div");
    messageElement.classList.add("message", ...cssClasses);
    messageElement.innerHTML = html;
    return messageElement;
}
function showTypingEffect(rawText, htmlText, messageElement, incomingMessageElement, skipEffect = false, isImageGeneration = false) {
    const iconsContainer = incomingMessageElement.querySelector(".message__icons");
    if (skipEffect) {
        messageElement.innerHTML = htmlText;
        if (!isImageGeneration) {
            hljs.highlightAll();
            addCopyButtonToCodeBlocks();
            renderMathInElement(messageElement, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                ]
            });
        }
        iconsContainer.classList.remove("hide");
        isGeneratingResponse = false;
        const loadingIndicator = incomingMessageElement.querySelector('.message__loading-indicator');
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        return;
    }
    if (isImageGeneration) {
        const loadingMessage = incomingMessageElement.querySelector('.image-loading-message');
        if (loadingMessage) {
            loadingMessage.remove();
        }
        const messageContent = incomingMessageElement.querySelector('.message__content');
        if (messageContent) {
            messageContent.innerHTML = `<div class="message__text">${htmlText}</div>`;
        }
        iconsContainer.classList.remove("hide");
        isGeneratingResponse = false;
        smoothScrollSlow(chatHistoryContainer);
        setTimeout(() => {
            const successMessage = messageContent.querySelector('.image-success-message');
            if (successMessage) {
                successMessage.style.transition = 'opacity 0.5s ease';
                successMessage.style.opacity = '0';
                setTimeout(() => {
                    if (successMessage.parentNode) {
                        successMessage.parentNode.removeChild(successMessage);
                    }
                }, 500);
            }
        }, 10000);
        return;
    }
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = htmlText;
    const fragment = document.createDocumentFragment();
    Array.from(tempContainer.childNodes).forEach((node) => {
        fragment.appendChild(node.cloneNode(true));
    });
    let nodeIndex = 0;
    const typingInterval = setInterval(() => {
        if (nodeIndex < fragment.childNodes.length) {
            const currentNode = fragment.childNodes[nodeIndex];
            messageElement.appendChild(currentNode.cloneNode(true));
            nodeIndex++;
        } else {
            clearInterval(typingInterval);
            isGeneratingResponse = false;
            hljs.highlightAll();
            addCopyButtonToCodeBlocks();
            iconsContainer.classList.remove("hide");
            const loadingIndicator = incomingMessageElement.querySelector('.message__loading-indicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            smoothScrollSlow(chatHistoryContainer);
            renderMathInElement(messageElement, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                ]
            });
        }
    }, 75);
}
function addCopyButtonToCodeBlocks() {
    const codeBlocks = document.querySelectorAll('pre');
    codeBlocks.forEach((block) => {
        if (block.parentElement.classList.contains('code-block-wrapper')) return;
        const codeElement = block.querySelector('code');
        let language = [...codeElement.classList].find(cls => cls.startsWith('language-'))?.replace('language-', '') || 'Text';
        const wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        const header = document.createElement('div');
        header.className = 'code-block-header';
        const languageLabel = document.createElement('div');
        languageLabel.className = 'code__language-label';
        languageLabel.innerText = language.charAt(0).toUpperCase() + language.slice(1);
        const iconsGroup = document.createElement('div');
        iconsGroup.className = 'icons-group';
        const copyButton = document.createElement('button');
        copyButton.innerHTML = `<i class='bx bx-copy'></i>`;
        copyButton.className = 'code__copy-btn';
        copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(codeElement.innerText).then(() => {
                copyButton.innerHTML = `<i class='bx bx-check'></i>`;
                showToast('Code copied to clipboard', 'success');
                setTimeout(() => copyButton.innerHTML = `<i class='bx bx-copy'></i>`, 2000);
            }).catch(err => {
                console.error("Copy failed:", err);
                showToast('Failed to copy code', 'error');
            });
        });
        iconsGroup.appendChild(copyButton);
        const downloadButton = document.createElement('button');
        downloadButton.innerHTML = `<i class='bx bx-download'></i>`;
        downloadButton.className = 'code__copy-btn'; // Reuse style
        downloadButton.addEventListener('click', () => {
            const blob = new Blob([codeElement.innerText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `code.${language.toLowerCase() || 'txt'}`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Code downloaded', 'success');
        });
        iconsGroup.appendChild(downloadButton);
        if (language.toLowerCase() === 'html') {
            const runButton = document.createElement('button');
            runButton.innerHTML = `<i class='bx bx-play'></i>`;
            runButton.className = 'code__copy-btn'; // Reuse style
            runButton.addEventListener('click', () => {
                openCodePreview(codeElement.innerText);
            });
            iconsGroup.appendChild(runButton);
        }
        header.appendChild(languageLabel);
        header.appendChild(iconsGroup);
        block.parentNode.insertBefore(wrapper, block);
        wrapper.appendChild(header);
        wrapper.appendChild(block);
    });
}
function openCodePreview(code) {
    const iframe = document.getElementById('codePreviewIframe');
    iframe.srcdoc = code;
    document.getElementById('codePreviewOverlay').classList.add('show');
}
function closeCodePreview() {
    document.getElementById('codePreviewOverlay').classList.remove('show');
    const iframe = document.getElementById('codePreviewIframe');
    iframe.srcdoc = '';
}
function displayLoadingAnimation(options) {
    if (options.deepThink) {
        const thinkingMessage = document.createElement('div');
        thinkingMessage.className = 'message message--incoming message--thinking';
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'message__content';
        const reasoningContainer = document.createElement('div');
        reasoningContainer.className = 'reasoning-container active';
        reasoningContainer.innerHTML = `
            <div class="reasoning-title">
                <i class='bx bx-atom'></i> Thinking
            </div>
            <div class="reasoning-loading">
                <div class="reasoning-loading-dot"></div>
                <div class="reasoning-loading-dot"></div>
                <div class="reasoning-loading-dot"></div>
            </div>
            <div class="reasoning-content" id="reasoning-content-${Date.now()}">
                Analyzing your question...
            </div>
        `;
        contentWrapper.appendChild(reasoningContainer);
        thinkingMessage.appendChild(contentWrapper);
        chatHistoryContainer.appendChild(thinkingMessage);
        scrollToBottom();
        simulateThinkingProcess(reasoningContainer.querySelector('.reasoning-content'));
        const responsePlaceholderHtml = `
            <div class="message__content">
                <p class="message__text"></p>
            </div>
            <div class="message__icons hide">
                <span onClick="copyMessageToClipboard(this)" class="message__icon"><i class='bx bx-copy-alt'></i></span>
                <span class="message__icon like"><i class='bx bx-like'></i></span>
                <span class="message__icon dislike"><i class='bx bx-dislike'></i></span>
            </div>
        `;
        const responseMessageElement = createChatMessageElement(responsePlaceholderHtml, "message--incoming");
        chatHistoryContainer.appendChild(responseMessageElement);
        scrollToBottom();
        requestApiResponse(responseMessageElement, options);
    } else if (options.imageGeneration) {
        const randomLoadingMessage = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
        const loadingHtml = `
            <div class="message__content">
                <div class="image-loading-message">${randomLoadingMessage}</div>
                <p class="message__text">
                    <div class="image-loading-container">
                        <div class="image-loading-box"></div>
                    </div>
                </p>
            </div>
            <div class="message__icons hide">
                <span onClick="downloadImage(this)" class="message__icon"><i class='bx bx-download'></i></span>
                <span onClick="editImage(this)" class="message__icon image-edit-btn"><i class='bx bx-pencil'></i></span>
                <span class="message__icon like"><i class='bx bx-like'></i></span>
                <span class="message__icon dislike"><i class='bx bx-dislike'></i></span>
            </div>
        `;
        const loadingMessageElement = createChatMessageElement(loadingHtml, "message--incoming", "message--loading", "message--image-loading");
        chatHistoryContainer.appendChild(loadingMessageElement);
        scrollToBottom();
        requestApiResponse(loadingMessageElement, options);
    } else {
        const loadingHtml = `
            <div class="message__content">
                <p class="message__text"></p>
                <div class="message__loading-indicator">
                    <div class="message__loading-bar"></div>
                    <div class="message__loading-bar"></div>
                    <div class="message__loading-bar"></div>
                </div>
            </div>
            <div class="message__icons hide">
                <span onClick="copyMessageToClipboard(this)" class="message__icon"><i class='bx bx-copy-alt'></i></span>
                <span class="message__icon like"><i class='bx bx-like'></i></span>
                <span class="message__icon dislike"><i class='bx bx-dislike'></i></span>
            </div>
        `;
        const loadingMessageElement = createChatMessageElement(loadingHtml, "message--incoming", "message--loading");
        const session = chatSessions.find(session => session.id === currentSessionId);
        if (session) {
            const chatIndex = session.chats.length - 1;
            loadingMessageElement.setAttribute('data-chat-index', chatIndex);
        }
        chatHistoryContainer.appendChild(loadingMessageElement);
        scrollToBottom();
        requestApiResponse(loadingMessageElement, options);
    }
}
function simulateThinkingProcess(reasoningContentElement) {
const thinkingSteps = [
    "Processing your input...",
    "Understanding the context...",
    "Accessing knowledge base...",
    "Analyzing relevant data...",
    "Structuring the response...",
    "Generating detailed answer...",
    "Reviewing for accuracy...",
    "Preparing final output..."
];
let stepIndex = 0;
const thinkingInterval = setInterval(() => {
    if (stepIndex < thinkingSteps.length) {
        updateThinkingText(reasoningContentElement, thinkingSteps[stepIndex]);
        stepIndex++;
    } else {
        clearInterval(thinkingInterval);
        updateThinkingText(reasoningContentElement, "Finalizing response...");
    }
}, 2000);
}
function updateThinkingText(element, text) {
    element.innerHTML = text;
}
    async function requestApiResponse(incomingMessageElement, options) {
        const messageTextElement = incomingMessageElement.querySelector(".message__text");
        try {
            const messages = Array.from(document.querySelectorAll('.message'));
            const formattedChats = [];
            for (let i = 0; i < messages.length; i += 2) {
                const userMessage = messages[i];
                const assistantMessage = messages[i + 1];
                if (userMessage && assistantMessage) {
                    formattedChats.push({
                        userInput: userMessage.querySelector('.message__text')?.textContent || '',
                        aiResponse: assistantMessage.querySelector('.message__text')?.textContent || ''
                    });
                }
            }
            let previousImagePrompt = "";
            if (options.imageModification) {
                for (let i = messages.length - 1; i >= 0; i--) {
                    const msg = messages[i];
                    if (msg.classList.contains('message--outgoing')) {
                        const text = msg.querySelector('.message__text')?.textContent;
                        if (text) {
                            previousImagePrompt = text;
                            break;
                        }
                    }
                }
            }
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            const response = await fetch('/predict', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: currentUserMessage,
                    previousChats: formattedChats,
                    userName: localStorage.getItem('username') || "User",
                    options: options,
                    previousImagePrompt: previousImagePrompt
                }),
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            const responseData = await response.json();
            if (!response.ok) throw new Error(responseData.error || "API request failed");
            let aiResponse = responseData.response;
            const isImageGeneration = responseData.isImageGeneration || false;
            let htmlText;
            if (isImageGeneration) {
                const randomSuccessMessage = successMessages[Math.floor(Math.random() * successMessages.length)];
                const imageUrl = aiResponse;
                const session = chatSessions.find(session => session.id === currentSessionId);
                if (session) {
                    const lastChat = session.chats[session.chats.length - 1];
                    lastChat.aiResponse = null;
                    lastChat.imageId = await saveChatImageToDB(await (await fetch(imageUrl)).blob());
                    lastChat.prompt = responseData.prompt || currentUserMessage;
                    saveChatSessions();
                }
                htmlText = `
                    <div class="image-success-message">${randomSuccessMessage}</div>
                    <div class="image-container">
                        <img src="${imageUrl}" alt="Generated Image" class="generated-image" data-prompt="${responseData.prompt || ''}" onerror="this.onerror=null; this.parentElement.innerHTML='<p style=\\'color: var(--error-color);\\'>Failed to load image. Please try again.</p>';">
                    </div>
                `;
            } else {
                htmlText = marked.parse(aiResponse);
                incomingMessageElement.classList.add('message--final-response');
            }
            const thinkingMessage = incomingMessageElement.previousElementSibling;
            if (thinkingMessage && thinkingMessage.classList.contains('message--thinking')) {
                thinkingMessage.remove();
            }
            if (options.deepThink && !isImageGeneration) {
                const badge = document.createElement('span');
                badge.className = 'think-badge';
                badge.innerHTML = '<i class="bx bx-atom"></i> Think';
                const messageContent = incomingMessageElement.querySelector('.message__content');
                if (messageContent) messageContent.insertBefore(badge, messageContent.firstChild);
            }
            showTypingEffect(aiResponse, htmlText, messageTextElement, incomingMessageElement, false, isImageGeneration);
            const session = chatSessions.find(session => session.id === currentSessionId);
            if (session) {
                session.chats[session.chats.length - 1].aiResponse = isImageGeneration ? null : aiResponse;
                session.chats[session.chats.length - 1].isImageGeneration = isImageGeneration;
                saveChatSessions();
            }
        } catch (error) {
            console.error("API Error:", error.message, error.stack);
            let errorMessage = "Network error Try Try Again!";
            if (error.name === 'AbortError') errorMessage = "Network error Try Again!";
            if (options.imageGeneration) {
                incomingMessageElement.innerHTML = '';
                const errorHtml = `
                    <div class="message__content">
                        <p class="message__text message--error">${errorMessage}</p>
                    </div>
                `;
                incomingMessageElement.innerHTML = errorHtml;
                incomingMessageElement.classList.remove('message--image-loading', 'message--loading', 'message--image');
            } else if (error.message.includes("context") || error.message.includes("long")) {
                errorMessage = "Your Context Window is Too Long as Galaxy";
            }
            if (messageTextElement) {
                messageTextElement.innerText = errorMessage;
                messageTextElement.closest(".message").classList.add("message--error");
            }
            showToast(errorMessage, 'error');
        } finally {
            isGeneratingResponse = false;
            incomingMessageElement.classList.remove("message--loading", "message--image-loading");
            pauseButton.style.display = "none";
            sendButton.style.display = "block";
            scrollToBottom();
        }
    }
function toggleLikeDislike(iconElement, type) {
const messageElement = iconElement.closest('.message--incoming');
if (!messageElement) {
    console.error('Message element not found');
    return;
}
const chatIndexStr = messageElement.getAttribute('data-chat-index');
if (!chatIndexStr) {
    console.error('data-chat-index not set');
    return;
}
const chatIndex = parseInt(chatIndexStr, 10);
if (isNaN(chatIndex)) {
    console.error('Invalid chat index:', chatIndexStr);
    return;
}
const session = chatSessions.find(session => session.id === currentSessionId);
if (!session) {
    console.error('Session not found');
    return;
}
if (chatIndex < 0 || chatIndex >= session.chats.length) {
    console.error('Chat index out of bounds:', chatIndex);
    return;
}
const currentFeedback = session.chats[chatIndex].feedback;
let newFeedback;
if (type === 'like') {
    newFeedback = currentFeedback === 'like' ? null : 'like';
} else if (type === 'dislike') {
    newFeedback = currentFeedback === 'dislike' ? null : 'dislike';
}
session.chats[chatIndex].feedback = newFeedback;
saveChatSessions();
// Remove 'last-feedback' from all messages
document.querySelectorAll('.message--incoming').forEach(msg => msg.classList.remove('last-feedback'));
const likeSpan = messageElement.querySelector('.message__icon.like');
const dislikeSpan = messageElement.querySelector('.message__icon.dislike');
if (newFeedback === 'like') {
    likeSpan.classList.add('selected');
    dislikeSpan.classList.remove('selected');
    messageElement.classList.add('last-feedback');
    showToast('Liked the message', 'success');
} else if (newFeedback === 'dislike') {
    dislikeSpan.classList.add('selected');
    likeSpan.classList.remove('selected');
    messageElement.classList.add('last-heatback');
    showToast('Disliked the message', 'success');
} else {
    likeSpan.classList.remove('selected');
    dislikeSpan.classList.remove('selected');
    showToast('Feedback removed', 'info');
}
}
let isCopying = false;
async function copyMessageToClipboard(copyButton) {
if (isCopying) return; // Prevent multiple multiple executions
isCopying = true;
const messageElement = copyButton.closest('.message');
const messageTextElement = messageElement.querySelector('.message__content .message__text');
if (!messageTextElement) {
    console.error('Message text not found!');
    showToast('Failed to copy: Message text not available', 'error');
    isCopying = false;
    return;
}
let messageContent;
if (messageTextElement.querySelector('.generated-image')) {
    const img = messageTextElement.querySelector('.generated-image');
    const imageId = img.getAttribute('data-image-id');
    if (imageId) {
        try {
            const blob = await getChatImageById(imageId);
            if (blob) {
                const base64 = await blobToBase64(blob);
                messageContent = base64;
            } else {
                messageContent = img.src;
            }
        } catch (error) {
            console.error('Error getting image for copy:', error);
            messageContent = img.src;
        }
    } else {
        messageContent = img.src;
    }
} else {
    messageContent = messageTextElement.innerText;
}
try {
    await navigator.clipboard.writeText(messageContent);
    copyButton.innerHTML = `<i class='bx bx-check'></i>`;
    showToast('Copied to clipboard', 'success'); // Only one toast
    setTimeout(() => {
        copyButton.innerHTML = `<i class='bx bx-copy-alt'></i>`;
        isCopying = false; // Reset flag after completion
    }, 1000);
} catch (err) {
    console.error('Clipboard API error:', err);
    const textarea = document.createElement('textarea');
    textarea.value = messageContent;
    document.body.appendChild(textarea);
    textarea.select();
    const success = document.execCommand('copy');
    document.body.removeChild(textarea);
    if (success) {
        copyButton.innerHTML = `<i class='bx bx-check'></i>`;
        showToast('Copied to clipboard', 'success'); // Only one toast
        setTimeout(() => {
            copyButton.innerHTML = `<i class='bx bx-copy-alt'></i>`;
            isCopying = false; // Reset flag after completion
        }, 1000);
    } else {
        showToast('Failed to copy to clipboard', 'error');
        isCopying = false;
    }
}
}
    function downloadImage(button) {
        const messageElement = button.closest('.message');
        const imgElement = messageElement.querySelector('.generated-image');
        if (imgElement) {
            const imageSrc = imgElement.src;
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = `generated-image-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Image downloaded', 'success');
        } else {
            showToast('Image not found', 'error');
        }
    }
    function editImage(button) {
        const messageElement = button.closest('.message');
        const imgElement = messageElement.querySelector('.generated-image');
        const previousMessage = messageElement.previousElementSibling;
        let originalPrompt = '';
        if (previousMessage && previousMessage.classList.contains('message--outgoing')) {
            originalPrompt = previousMessage.querySelector('.message__text').textContent;
        }
        if (imgElement) {
            const imageSrc = imgElement.src;
            const prompt = imgElement.getAttribute('data-prompt') || originalPrompt;
            const existingTag = document.querySelector('.edit-tag');
            if (existingTag) {
                existingTag.remove();
            }
            const editTag = document.createElement('div');
            editTag.className = 'edit-tag';
            editTag.innerHTML = `
                Edit Image
                <span class="edit-close" onclick="removeEditTag()">×</span>
            `;
            const promptSection = document.querySelector('.prompt__input-wrapper');
            promptSection.insertBefore(editTag, promptSection.firstChild);
            chatInput.value = prompt;
            chatInput.focus();
            optionsState.imageGeneration = true;
            optionsState.imageModification = true;
            const imageOption = document.querySelector('[data-option="imageGeneration"]');
            if (imageOption && !imageOption.classList.contains('selected')) {
                toggleOption(imageOption);
            }
        }
    }
    function removeEditTag() {
        const editTag = document.querySelector('.edit-tag');
        if (editTag) {
            editTag.remove();
        }
    }
    function trackImageContext() {
        const messages = Array.from(document.querySelectorAll('.message'));
        const recentMessages = messages.slice(-6);
        const hasRecentImage = recentMessages.some(msg => {
            const img = msg.querySelector('.generated-image');
            return img !== null;
        });
        return hasRecentImage;
    }
    function handleOutgoingMessage() {
        if (!currentUserMessage || isGeneratingResponse) return;
        isGeneratingResponse = true;
        document.body.classList.add("hide-header");
        if (!currentSessionId) {
            const newSession = {
                id: Date.now().toString(),
                name: "New Chat",
                chats: []
            };
            chatSessions.unshift(newSession);
            currentSessionId = newSession.id;
            sessionStorage.setItem('currentSessionId', currentSessionId);
            saveChatSessions();
            loadChatSessions();
        }
        document.querySelectorAll('.message--outgoing .message__icon.edit').forEach(editIcon => editIcon.remove());
        const outgoingMessageHtml = `
            <div class="message__content" style="display: flex; flex-direction: column; align-items: flex-end;">
                <p class="message__text">${sanitizeInput(currentUserMessage)}</p>
                <div class="message__icons" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <span class="message__icon copy"><i class='bx bx-copy-alt'></i></span>
                    <span class="message__icon edit"><i class='bx bx-pencil' ></i></span>
                </div>
            </div>
        `;
        const outgoingMessageElement = createChatMessageElement(outgoingMessageHtml, "message--outgoing");
        chatHistoryContainer.appendChild(outgoingMessageElement);
        removeEditTag();
        const session = chatSessions.find(session => session.id === currentSessionId);
        if (session) {
            session.chats.push({
                userInput: currentUserMessage,
                aiResponse: "",
                feedback: null,
                isImageGeneration: optionsState.imageGeneration,
                imageId: null
            });
            const sessionIndex = chatSessions.findIndex(s => s.id === currentSessionId);
            if (sessionIndex !== -1) {
                const [activeSession] = chatSessions.splice(sessionIndex, 1);
                chatSessions.unshift(activeSession);
            }
            saveChatSessions();
            loadChatSessions();
        }
        scrollToBottom();
        setTimeout(displayLoadingAnimation, 500);
    }
    function editMessage(editIcon) {
const messageElement = editIcon.closest('.message--outgoing');
        const messageTextElement = messageElement.querySelector('.message__text');
        const originalText = messageTextElement.textContent;
        messageElement.innerHTML = `
            <div class="message__content edit-container" style="position: relative; display: flex; flex-direction: column; align-items: flex-end;">
                <textarea class="edit-message-input" rows="5" style="width: 100%; overflow-y: auto; resize: none;">${originalText}</textarea>
                <div style="position: absolute; bottom: 0; right: 0.5rem; display: flex; gap: 0.5rem; z-index: 1;">
                    <button class="edit-message-cancel" data-original="${originalText.replace(/"/g, '&quot;')}">Cancel</button>
                    <button class="edit-message-submit" data-original="${originalText.replace(/"/g, '&quot;')}">Send</button>
                </div>
            </div>
        `;
        const textArea = messageElement.querySelector('.edit-message-input');
        textArea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });
        textArea.focus();
    }
    function cancelEdit(cancelButton) {
        const messageElement = cancelButton.closest('.message--outgoing');
        const originalText = cancelButton.getAttribute('data-original');
        messageElement.innerHTML = `
            <div class="message__content" style="display: flex; flex-direction: column; align-items: flex-end;">
                <p class="message__text">${originalText}</p>
                <div class="message__icons" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <span class="message__icon copy"><i class='bx bx-copy-alt'></i></span>
                    <span class="message__icon edit"><i class='bx bx-pencil'></i></span>
                </div>
            </div>
        `;
    }
    function determineOptions(message) {
    const lowerMessage = message.toLowerCase().trim();
    const words = lowerMessage.split(/\s+/);
    const firstFewWords = words.slice(0, 3).join(' ');
  
    function startsWithImageGenerationKeyword() {
        return imageGenerationKeywords.some(keyword => lowerMessage.startsWith(keyword));
    }
  
    function startsWithImageModificationKeyword() {
        return imageModificationKeywords.some(keyword => lowerMessage.startsWith(keyword));
    }
  
    const hasImageContext = trackImageContext();
  
    let options = {
        webSearch: lowerMessage.startsWith("search"),
        deepThink: lowerMessage.startsWith("think"),
        imageGeneration: false,
        imageModification: false,
    };
  
    if (startsWithImageGenerationKeyword()) {
        options.imageGeneration = true;
    } else if (startsWithImageModificationKeyword() && hasImageContext) {
        options.imageGeneration = true;
        options.imageModification = true;
    }
  
    return options;
}
    async function submitEditedMessage(submitButton) {
        const messageElement = submitButton.closest('.message--outgoing');
        const textArea = messageElement.querySelector('.edit-message-input');
        const editedText = sanitizeInput(textArea.value.trim());
        if (!editedText) {
            showToast('Edited message cannot be empty!', 'error');
            return;
        }
        // Determine options based on the edited text
        const editedOptions = determineOptions(editedText);
        const sessionIndex = chatSessions.findIndex(session => session.id === currentSessionId);
        if (sessionIndex !== -1) {
            const chatIndex = chatSessions[sessionIndex].chats.findIndex(chat => chat.userInput === submitButton.getAttribute('data-original'));
            if (chatIndex !== -1) {
                const originalChat = chatSessions[sessionIndex].chats[chatIndex];
                if (originalChat.imageId) {
                    try {
                        await deleteChatImageById(originalChat.imageId);
                    } catch (error) {
                        console.error('Failed to delete old image:', error);
                    }
                }
                // Update chat with edited text and options
                chatSessions[sessionIndex].chats[chatIndex].userInput = editedText;
                chatSessions[sessionIndex].chats[chatIndex].aiResponse = "";
                chatSessions[sessionIndex].chats[chatIndex].feedback = null;
                chatSessions[sessionIndex].chats[chatIndex].imageId = null;
                chatSessions[sessionIndex].chats[chatIndex].isImageGeneration = editedOptions.imageGeneration;
                const [activeSession] = chatSessions.splice(sessionIndex, 1);
                chatSessions.unshift(activeSession);
                saveChatSessions();
                loadChatSessions();
            }
        }
        messageElement.innerHTML = `
            <div class="message__content" style="display: flex; flex-direction: column; align-items: flex-end;">
                <p class="message__text">${editedText}</p>
                <div class="message__icons" style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <span class="message__icon copy"><i class='bx bx-copy-alt'></i></span>
                    <span class="message__icon edit"><i class='bx bx-pencil' ></i></span>
                </div>
            </div>
        `;
        const nextMessage = messageElement.nextElementSibling;
        if (nextMessage && nextMessage.classList.contains('message--incoming')) {
            nextMessage.remove();
        }
        currentUserMessage = editedText;
        isGeneratingResponse = false;
        // Pass the determined options to displayLoadingAnimation
        setTimeout(() => displayLoadingAnimation(editedOptions), 500);
    }
    function clearChatHistory() {
        chatHistoryContainer.innerHTML = "";
    }
    function openSettings(highlightSection = false) {
    document.getElementById("settingsPage").classList.add("active");
    if (highlightSection) {
        let sectionIndex = 0;
        if (highlightSection === "theme") sectionIndex = 2;
        else if (highlightSection === "profile") sectionIndex = 1;
        const section = document.querySelector(`.settings-section:nth-child(${sectionIndex})`);
        if (section) {
            section.scrollIntoView({ behavior: 'smooth' });
            section.classList.add('highlight');
            setTimeout(() => {
                section.classList.remove('highlight');
            }, 5000);
        }
    }
}
    function showSection(section) {
        document.querySelectorAll('.popup__tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.popup__tab-content').forEach(content => {
            content.classList.remove('active');
        });
        const selectedTab = document.querySelector(`.popup__tab[data-tab="${section}"]`);
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
        const selectedContent = document.getElementById(section);
        if (selectedContent) {
            selectedContent.classList.add('active');
        }
        if (section === "personalization") {
            loadImageGallery();
        }
    }
    function editProfile() {
    openSettings("profile"); // Pass a string to indicate which section to highlight
}
    function editChats() {
        openSettings();
    }
  
    function edittheme() {
        openSettings("theme");
    }
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                compressAndResizeImage(img);
            };
        };
        reader.readAsDataURL(file);
    }
    function compressAndResizeImage(img) {
        let quality = 0.9;
        let maxSize = 100 * 1024;
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        const maxWidth = 1024;
        const maxHeight = 1024;
        let width = img.width;
        let height = img.height;
        if (width > maxWidth || height > maxHeight) {
            const aspectRatio = width / height;
            if (width > height) {
                width = maxWidth;
                height = Math.round(width / aspectRatio);
            } else {
                height = maxHeight;
                width = Math.round(height * aspectRatio);
            }
        }
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        function checkSize() {
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            const size = dataUrl.length * 0.75;
            if (size <= maxSize) {
                const compressedImg = new Image();
                compressedImg.src = dataUrl;
                document.body.appendChild(compressedImg);
            } else {
                if (quality > 0.1) {
                    quality -= 0.1;
                    checkSize();
                } else {
                    const compressedImg = new Image();
                    compressedImg.src = dataUrl;
                    document.body.appendChild(compressedImg);
                }
            }
        }
        checkSize();
    }
    function cropImage(img) {
        const canvas = document.createElement("canvas");
        const size = Math.min(img.width, img.height);
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(
            img,
            (img.width - size) / 2,
            (img.height - size) / 2,
            size,
            size,
            0,
            0,
            size,
            size
        );
        const croppedImage = canvas.toDataURL("image/png");
        localStorage.setItem("profileImage", croppedImage);
        document.getElementById("profileAvatar").src = croppedImage;
    }
    function saveUserName() {
        const usernameInput = document.getElementById("username");
        if (usernameInput.value) {
            localStorage.setItem("username", usernameInput);
            usernameInput.disabled = true;
            const editIcon = document.querySelector('.username-container .edit-icon');
            if (editIcon) {
                editIcon.style.display = 'inline';
            }
        }
    }
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageSrc = e.target.result;
                tempProfileImage = imageSrc;
                tempProfileImageId = null;
                const profileImagePreview = document.getElementById("profileImagePreview");
                if (profileImagePreview) {
                    profileImagePreview.src = imageSrc;
                }
                enableSaveButton();
            };
            reader.readAsDataURL(file);
        }
    }
    function listAllImages() {
        if (!db) {
            console.error("Database not initialized.");
            return;
        }
        const transaction = db.transaction(["profileImages"], "readonly");
        const objectStore = transaction.objectStore("profileImages");
        const request = objectStore.getAll();
        request.onsuccess = (event) => console.log("All images:", event.target.result);
    }
    function getUserAvatarSrc() {
        const storedImage = localStorage.getItem("profileImage");
        return storedImage ? storedImage : "../static/images/user.webp";
    }
    function saveProfileImageToDB(imageData) {
        return new Promise((resolve, reject) => {
            if (!db) {
                reject("Database not initialized");
                return;
            }
            const transaction = db.transaction(["profileImages"], "readwrite");
            const objectStore = transaction.objectStore("profileImages");
            const data = {
                image: imageData,
                timestamp: Date.now(),
                lastUsed: Date.now()
            };
            const request = objectStore.add(data);
            request.onsuccess = function(event) {
                resolve(event.target.result);
            };
            request.onerror = function(event) {
                console.error("Error saving image:", event.target.error);
                reject(event.target.error);
            };
        });
    }
    function getProfileImageById(id) {
        return new Promise((resolve, reject) => {
            if (!db) {
                reject("Database not initialized");
                return;
            }
            const transaction = db.transaction(["profileImages"], "readonly");
            const objectStore = transaction.objectStore("profileImages");
            const request = objectStore.get(Number(id));
            request.onsuccess = function(event) {
                const result = event.target.result;
                if (result && result.image) {
                    const blob = result.image;
                    const url = URL.createObjectURL(blob);
                    resolve(url);
                } else {
                    resolve(null);
                }
            };
            request.onerror = function(event) {
                console.error("Error retrieving image:", event.target.error);
                reject(event.target.error);
            };
        });
    }
    function getAllProfileImagesFromDB() {
        return new Promise((resolve, reject) => {
            if (!db) {
                reject("Database not initialized");
                return;
            }
            const transaction = db.transaction(["profileImages"], "readonly");
            const objectStore = transaction.objectStore("profileImages");
            const request = objectStore.getAll();
            request.onsuccess = function(event) {
                let images = event.target.result;
                images.sort((a, b) => b.lastUsed - a.lastUsed);
                resolve(images);
            };
            request.onerror = function(event) {
                console.error("Error retrieving images:", event.target.error);
                reject(event.target.error);
            };
        });
    }
    function loadImageGallery() {
        const gallery = document.getElementById("imageGallery");
        gallery.innerHTML = "";
        getAllProfileImagesFromDB()
            .then((images) => {
                const recentImages = images.slice(0, 5);
                recentImages.forEach((item) => {
                    const blobURL = URL.createObjectURL(item.image);
                    const img = document.createElement("img");
                    img.src = blobURL;
                    img.style.width = "50px";
                    img.style.height = "50px";
                    img.style.borderRadius = "50%";
                    img.style.cursor = "pointer";
                    img.dataset.id = item.id;
                    img.onclick = () => {
                        tempProfileImage = blobURL;
                        tempProfileImageId = item.id;
                        document.getElementById("profileImagePreview").src = blobURL;
                        enableSaveButton();
                    };
                    gallery.appendChild(img);
                });
                if (images.length > 5) {
                    const imagesToDelete = images.slice(5);
                    imagesToDelete.forEach((image) => {
                        deleteImageFromDB(image.id);
                    });
                }
            })
            .catch((error) => {
                console.error("Failed to load image gallery:", error);
            });
    }
    function deleteImageFromDB(id) {
        const transaction = db.transaction(["profileImages"], "readwrite");
        const objectStore = transaction.objectStore("profileImages");
        const request = objectStore.delete(id);
        request.onsuccess = function(event) {
            console.log(`Image with ID ${id} deleted.`);
        };
        request.onerror = function(event) {
            console.error(`Failed to delete image with ID ${id}:`, event.target.errorCode);
        };
    }
    function updateImageLastUsed(id) {
        const transaction = db.transaction(["profileImages"], "readwrite");
        const objectStore = transaction.objectStore("profileImages");
        const request = objectStore.get(id);
        request.onsuccess = function(event) {
            const data = event.target.result;
            if (data) {
                data.lastUsed = Date.now();
                const updateRequest = objectStore.put(data);
                updateRequest.onsuccess = function() {
                    console.log(`Updated lastUsed for image ID ${id}`);
                };
            }
        };
        request.onerror = function(event) {
            console.error(`Failed to update lastUsed for image ID ${id}:`, event.target.errorCode);
        };
    }
    function saveUserProfile() {
        const usernameInput = sanitizeInput(document.getElementById("username").value);
        const dobInput = sanitizeInput(document.getElementById("dob").value);
        const userProfileIcon = document.getElementById("userProfileIcon");
        const greetingText = document.getElementById("greeting");
        const usernameField = document.getElementById("username");
        const editIcon = document.querySelector('.username-container .edit-icon');
        const subMenuUser = document.getElementById("subMenuUser");
        const subMenuUserProfile = document.getElementById("subMenuUserProfile");
        if (usernameInput) {
            localStorage.setItem("username", usernameInput);
            subMenuUser.textContent = usernameInput || "User";
            greetingText.textContent = `Hello, ${usernameInput || "User"}!`;
            usernameField.disabled = true;
            editIcon.style.display = 'block';
            previousUserName = usernameInput;
        }
        if (dobInput) {
            localStorage.setItem("dob", dobInput);
            previousDOB = dobInput;
        }
        if (tempProfileImage) {
            if (tempProfileImageId) {
                localStorage.setItem("currentProfileImageId", tempProfileImageId);
                console.log("Saved gallery image ID to localStorage:", tempProfileImageId);
                updateImageLastUsed(tempProfileImageId);
                getProfileImageById(tempProfileImageId)
                    .then((url) => {
                        userProfileIcon.src = url;
                        subMenuUserProfile.src = url;
                        document.getElementById("profileImagePreview").src = url;
                        previousProfileImage = url;
                        tempProfileImage = null;
                        tempProfileImageId = null;
                        enableSaveButton();
                    });
            } else {
            compressImage(tempProfileImage, 0.7)
                .then((blob) => {
                    saveProfileImageToDB(blob)
                        .then((id) => {
                            localStorage.setItem("currentProfileImageId", id);
                            console.log("Saved new image ID to localStorage:", id);
                                getProfileImageById(id)
                                    .then((url) => {
                                        userProfileIcon.src = url;
                                        subMenuUserProfile.src = url;
                                        document.getElementById("profileImagePreview").src = url;
                                        previousProfileImage = url;
                                        tempProfileImage = null;
                                        tempProfileImageId = null;
                                        enableSaveButton();
                                    });
                            })
                            .catch((error) => {
                                console.error("Failed to save profile image:", error);
                            });
                    })
                    .catch((error) => {
                        console.error("Failed to compress image:", error);
                    });
            }
        } else {
            enableSaveButton();
        }
        showToast('Profile saved successfully', 'success');
    }
    function getProfileImageFromDB() {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(["profileImages"], "readonly");
            const objectStore = transaction.objectStore("profileImages");
            const request = objectStore.openCursor(null, 'prev');
            request.onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor && cursor.value.image) {
                    const blob = cursor.value.image;
                    const url = URL.createObjectURL(blob);
                    resolve(url);
                } else {
                    resolve(null);
                }
            };
            request.onerror = function(event) {
                reject(event.target.errorCode);
            };
        });
    }
    function compressImage(imageDataUrl, quality) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = imageDataUrl;
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, img.width, img.height);
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, "image/jpeg", quality);
            };
            img.onerror = () => {
                reject("Failed to load image for compression.");
            };
        });
    }
    function enableSaveButton() {
        const usernameInput = document.getElementById("username").value.trim();
        const dobInput = document.getElementById("dob").value;
        const currentProfileImage = tempProfileImage || previousProfileImage;
        const saveButton = document.getElementById("saveButton");
        const isUsernameValid = usernameInput !== "";
        const hasUsernameChanged = usernameInput !== previousUserName;
        const hasDOBChanged = dobInput !== previousDOB;
        const hasImageChanged = currentProfileImage !== previousProfileImage;
        const hasChanges = (hasUsernameChanged && isUsernameValid) || hasDOBChanged || hasImageChanged;
        saveButton.disabled = !hasChanges;
    }
    function enableEdit(inputId) {
        const inputField = document.getElementById(inputId);
        const editIcon = document.querySelector('.username-container .edit-icon');
        inputField.disabled = false;
        inputField.focus();
        if (editIcon) {
            editIcon.style.display = 'none';
        }
    }
    function closeSettings() {
        document.getElementById("settingsPage").classList.remove("active");
        getProfileImageFromDB()
            .then((storedImage) => {
                const image = storedImage || "../static/images/user.webp";
                document.getElementById("profileImagePreview").src = image;
            })
            .catch(() => {
                document.getElementById("profileImagePreview").src = "../static/images/user.webp";
            });
        const storedName = localStorage.getItem("username") || "";
        const usernameField = document.getElementById("username");
        if (usernameField) {
            usernameField.value = storedName;
            usernameField.disabled = !!storedName;
        }
        const storedDOB = localStorage.getItem("dob") || "";
        const dobField = document.getElementById("dob");
        if (dobField) dobField.value = storedDOB;
        const editIcon = document.querySelector('.username-container .edit-icon');
        if (editIcon) {
            editIcon.style.display = storedName ? 'block' : 'none';
        }
        tempProfileImage = null;
        enableSaveButton();
    }
    function clearChats() {
        console.log("Clearing chat history...");
        chatHistoryContainer.innerHTML = '';
        chatSessions = [];
        currentSessionId = null;
        currentUserMessage = null;
        isGeneratingResponse = false;
        saveChatSessions();
        closeSettings();
        const navbar = document.querySelector('.navbar');
        if (navbar) {
            navbar.style.display = 'block';
        } else {
            console.warn("Navbar element not found in the DOM.");
        }
        document.body.classList.remove("hide-header");
        initializeChatSessions();
        showToast('Chat history cleared', 'success');
        console.log("Chat history cleared successfully.");
    }
    function toggleSidebar() {
        if (!sidebar.classList.contains('open')) {
            sidebarToggler.classList.add('rotate');
            setTimeout(() => {
                sidebar.classList.add('open');
                overlay.classList.add('show');
                sidebarToggler.classList.add('hidden');
                sidebarToggler.classList.remove('rotate');
            }, 1000);
        }
    }
    function closeSidebar() {
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            sidebarToggler.classList.remove('hidden');
            sidebarToggler.classList.add('reverseRotate');
            setTimeout(() => {
                sidebarToggler.classList.remove('reverseRotate');
            }, 1000);
        }
    }
    function scrollToBottom() {
        chatHistoryContainer.scrollTo({
            top: chatHistoryContainer.scrollHeight,
            behavior: 'smooth'
        });
    }
    function resetTextareaHeight() {
        chatInput.style.height = "60px";
        chatInput.style.minHeight = "4rem";
    }
    function smoothScrollSlow(container) {
        let targetScroll = container.scrollHeight;
        let currentScroll = container.scrollTop;
        let scrollStep = 3;
        let scrollInterval = null;
        function startScroll() {
            scrollInterval = setInterval(function() {
                if (currentScroll < targetScroll) {
                    currentScroll += scrollStep;
                    container.scrollTo({ top: currentScroll, behavior: "smooth" });
                } else {
                    clearInterval(scrollInterval);
                }
            }, 10);
        }
        startScroll();
        function stopScroll() {
            clearInterval(scrollInterval);
        }
        container.addEventListener('touchstart', stopScroll);
        container.addEventListener('mousedown', stopScroll);
    }
    function showConfirmationPopup(message, callback) {
        document.querySelector('.confirmation_message').textContent = message;
        document.querySelector('.confirmation_popup').style.display = 'block';
        document.querySelector('.confirmation_popup').setAttribute('data-callback', callback);
    }
    function cancelPopup() {
        document.querySelector('.confirmation_popup').style.display = 'none';
    }
    function confirmAction() {
        const callback = document.querySelector('.confirmation_popup').getAttribute('data-callback');
        document.querySelector('.confirmation_popup').style.display = 'none';
        if (callback && typeof window[callback] === 'function') {
            window[callback]();
        }
    }
    function applyTheme(theme) {
        document.body.classList.remove("light_mode", "dark_mode", "byte_mode","aurora_night_mode","midnight_tech_mode","warm_dusk_mode");
        if (theme === "system") {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.body.classList.add(prefersDark ? "dark_mode" : "light_mode");
        } else {
            document.body.classList.add(`${theme}_mode`);
        }
    }
    function clearBrowserData() {
    console.log("Clearing browser data...");
    let chatSessions = [];
    let currentSessionId = null;
    let currentUserMessage = null;
    let isGeneratingResponse = false;
    function deleteIndexedDB() {
        return new Promise((resolve, reject) => {
            let db = window.dbPromise ? window.dbPromise.db : null;
            if (db) {
                db.close();
            }
            const deleteRequest = indexedDB.deleteDatabase("userProfileDB");
            deleteRequest.onsuccess = function() {
                console.log("IndexedDB database 'userProfileDB' deleted successfully.");
                resolve();
            };
            deleteRequest.onerror = function(event) {
                console.error("Failed to delete IndexedDB database:", event.target.errorCode);
                resolve();
            };
            deleteRequest.onblocked = function() {
                console.warn("Database deletion blocked. Please close all connections.");
                resolve();
            };
        });
    }
    function reinitializeIndexedDB() {
        return new Promise((resolve, reject) => {
            window.dbPromise = new Promise((res, rej) => {
                const request = indexedDB.open("userProfileDB", 1);
                request.onupgradeneeded = function(event) {
                    const newDb = event.target.result;
                    newDb.createObjectStore("profileImages", { keyPath: "id", autoIncrement: true });
                    newDb.createObjectStore("chatImages", { keyPath: "id", autoIncrement: true });
                };
                request.onsuccess = function(event) {
                    window.dbPromise.db = event.target.result;
                    res(event.target.result);
                };
                request.onerror = function(event) {
                    console.error("Failed to reinitialize IndexedDB:", event.target.errorCode);
                    rej(event.target.errorCode);
                };
            });
            window.dbPromise.then(resolve).catch(reject);
        });
    }
    Promise.all([
        deleteIndexedDB().then(() => new Promise(resolve => setTimeout(resolve, 500))),
        new Promise((resolve) => {
            localStorage.clear();
            sessionStorage.clear();
            console.log("LocalStorage and SessionStorage cleared.");
            resolve();
        }),
        new Promise((resolve) => {
            const cookies = document.cookie.split(";");
            cookies.forEach(cookie => {
                const cookieName = cookie.split("=")[0].trim();
                const paths = ["/", "/ai", "/static"];
                paths.forEach(path => {
                    document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${path};`;
                });
            });
            console.log("Cookies cleared.");
            resolve();
        }),
        new Promise((resolve, reject) => {
            if ('caches' in window) {
                caches.keys().then(cacheNames => {
                    Promise.all(cacheNames.map(cacheName => {
                        return caches.delete(cacheName).then(success => {
                            if (success) {
                                console.log(`Cache ${cacheName} cleared.`);
                            } else {
                                console.error(`Failed to clear cache ${cacheName}.`);
                            }
                        }).catch(err => {
                            console.error(`Error clearing cache ${cacheName}:`, err);
                        });
                    })).then(resolve).catch(reject);
                }).catch(err => {
                    console.error('Error while retrieving cache keys:', err);
                    resolve();
                });
            } else {
                console.warn('Cache API not supported in this browser.');
                resolve();
            }
        })
    ])
    .then(() => {
        chatSessions = [];
        currentSessionId = null;
        currentUserMessage = null;
        isGeneratingResponse = false;
        localStorage.setItem("chatSessions", JSON.stringify(chatSessions));
        const chatHistoryContainer = document.querySelector(".chats");
        if (chatHistoryContainer) {
            chatHistoryContainer.innerHTML = "";
        }
        document.body.classList.remove("hide-header");
        const navbar = document.querySelector('.navbar');
        if (navbar) {
            navbar.style.display = 'flex';
        } else {
            console.warn("Navbar element not found in the DOM.");
        }
        const profileImageElements = [
            document.getElementById("profileImagePreview"),
            document.getElementById("userProfileIcon"),
            document.getElementById("subMenuUserProfile")
        ];
        profileImageElements.forEach(element => {
            if (element) element.src = "../static/images/user.webp";
        });
        const usernameElements = [
            document.getElementById("username"),
            document.getElementById("subMenuUser")
        ];
        usernameElements.forEach(element => {
            if (element) {
                if (element.id === "username") {
                    element.value = "";
                    element.disabled = false;
                } else {
                    element.textContent = "User";
                }
            }
        });
        const dobField = document.getElementById("dob");
        if (dobField) dobField.value = "";
        const greetingText = document.getElementById("greeting");
        if (greetingText) greetingText.textContent = "Hello, User!";
        const saveButton = document.getElementById("saveButton");
        if (saveButton) saveButton.disabled = true;
        return reinitializeIndexedDB();
    })
    .then(() => {
        console.log("Browser data cleared successfully.");
        showToast('All browser data cleared successfully', 'success');
        window.location.reload();
    })
    .catch(error => {
        console.error("Error clearing browser data:", error);
        showToast('Failed to clear some browser data', 'error');
    });
}
    function clearCache() {
    console.log("Clearing cache...");
    if ('caches' in window) {
        caches.keys().then(cacheNames => {
            Promise.all(cacheNames.map(cacheName => {
                return caches.delete(cacheName).then(success => {
                    if (success) {
                        console.log(`Cache ${cacheName} cleared.`);
                    } else {
                        console.error(`Failed to clear cache ${cacheName}.`);
                    }
                });
            })).then(() => {
                console.log("Cache cleared successfully.");
                showToast('Cache cleared successfully', 'success');
                // Optional: window.location.reload(); // Add if refresh is desired
            }).catch(err => {
                console.error('Error while clearing caches:', err);
                showToast('Failed to clear cache', 'error');
            });
        }).catch(err => {
            console.error('Error while retrieving cache keys:', err);
            showToast('Failed to clear cache', 'error');
        });
    } else {
        console.warn('Cache API not supported in this browser.');
        showToast('Cache cleared successfully', 'success'); // Still show success for consistency
    }
}
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
            window.innerWidth <= 768;
    }
    function updateScrollButtonVisibility() {
        if (chatHistoryContainer.scrollHeight <= chatHistoryContainer.clientHeight) {
            scrollToBottomButton.style.display = "none";
            return;
        }
        const distanceFromBottom = chatHistoryContainer.scrollHeight -
            (chatHistoryContainer.scrollTop + chatHistoryContainer.clientHeight);
        const threshold = 20;
        const isNearBottom = distanceFromBottom <= threshold;
        scrollToBottomButton.style.display = isNearBottom ? "none" : "block";
    }
    function toggleOption(optionElement) {
        const option = optionElement.getAttribute('data-option');
        if (optionsState[option]) {
            optionsState[option] = false;
            optionElement.classList.remove('selected');
        } else {
            Object.keys(optionsState).forEach(key => {
                optionsState[key] = false;
                document.querySelector(`[data-option="${key}"]`)?.classList.remove('selected');
            });
            optionsState[option] = true;
            optionElement.classList.add('selected');
        }
    }
    function resetOptions() {
        Object.keys(optionsState).forEach(key => {
            optionsState[key] = false;
            document.querySelector(`[data-option="${key}"]`)?.classList.remove('selected');
        });
    }
    function openImageOverlay(imgElement) {
        const imageSrc = imgElement.src;
        overlayImage.src = imageSrc;
        imageOverlay.classList.add('show');
        overlayImage.setAttribute('data-src', imageSrc);
        overlayImage.setAttribute('data-image-id', imgElement.getAttribute('data-image-id') || '');
        overlayImage.setAttribute('data-prompt', imgElement.getAttribute('data-prompt') || '');
    }
    function closeImageOverlay() {
        imageOverlay.classList.remove('show');
    }
    function downloadOverlayImage() {
        const imageSrc = overlayImage.getAttribute('data-src');
        const link = document.createElement('a');
        link.href = imageSrc;
        link.download = `generated-image-${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Image downloaded', 'success');
    }
    function editOverlayImage() {
        const imageSrc = overlayImage.getAttribute('data-src');
        const imagePrompt = overlayImage.getAttribute('data-prompt');
        closeImageOverlay();
        const existingTag = document.querySelector('.edit-tag');
        if (existingTag) {
            existingTag.remove();
        }
        const editTag = document.createElement('div');
        editTag.className = 'edit-tag';
        editTag.innerHTML = `
            Edit Image
            <span class="edit-close" onclick="removeEditTag()">×</span>
        `;
        const promptSection = document.querySelector('.prompt__input-wrapper');
        promptSection.insertBefore(editTag, promptSection.firstChild);
        chatInput.value = imagePrompt;
        chatInput.focus();
        optionsState.imageGeneration = true;
        optionsState.imageModification = true;
        const imageOption = document.querySelector('[data-option="imageGeneration"]');
        if (imageOption && !imageOption.classList.contains('selected')) {
            toggleOption(imageOption);
        }
    }
    imageOverlay.addEventListener('click', function(e) {
        if (e.target === imageOverlay) {
            closeImageOverlay();
        }
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && imageOverlay.classList.contains('show')) {
            closeImageOverlay();
        }
    });
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = '';
        switch(type) {
            case 'success':
                icon = '<i class="fas fa-check-circle toast-icon"></i>';
                break;
            case 'error':
                icon = '<i class="fas fa-exclamation-circle toast-icon"></i>';
                break;
            case 'warning':
                icon = '<i class="fas fa-exclamation-triangle toast-icon"></i>';
                break;
            default:
                icon = '<i class="fas fa-info-circle toast-icon"></i>';
        }
        toast.innerHTML = `
            ${icon}
            <div class="toast-message">${message}</div>
        `;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
     </script>
</body>
</html>